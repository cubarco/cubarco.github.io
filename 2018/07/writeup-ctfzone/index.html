<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Writeup: CTFZone 2018 Quals - /home/cubl</title><meta property="og:title" content="Writeup: CTFZone 2018 Quals - /home/cubl"><link href=https://cubl.in/favicon.ico rel=icon type=image/x-icon><meta name=description content="Pwning for fun."><link rel=stylesheet href=/css/main.min.39d87073ffff84c35a9b5d21e8b94ef0643a51af7a909c6f3d506433db4442a1.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Writeup: CTFZone 2018 Quals</h1><span class=article-date>2018-07-23</span>
<a class=article-tag href=/tags/hack>Hack</a>
<a class=article-tag href=/tags/ctf>CTF</a>
<a class=article-tag href=/tags/writeup>Writeup</a>
<a class=article-tag href=/tags/exploitation>Exploitation</a>
<a class=article-tag href=/tags/pwn>PWN</a><div class=article-content><p>ä¸¤é“PWNé¢˜, ä¸€ä¸ªeasypwn_strings, ä¸€ä¸ªMobile Bank.</p><h2 id=easypwn_strings>easypwn_strings</h2><h3 id=é—®é¢˜>é—®é¢˜</h3><blockquote><p>You can try to use very interesting and strange string functions ;) Good luck. <code>nc pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one 1234</code> And yes, there is no binary here</p></blockquote><p>è¿™æ˜¯ä¸€é“<strong>ç›²pwn</strong>ç±»å‹çš„é¢˜ï¼Œ<del>åä¹‰ä¸Š</del>æ²¡æœ‰æä¾›äºŒè¿›åˆ¶ã€‚</p><p>ncè¿ä¸Šä¹‹åå›æ˜¾ï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Let&#39;s choose string operation!
	1. StrLen
	2. SubStrRemove
	3. StrRemoveLastSymbols
</code></pre></div><p>ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼šè¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå›æ˜¾å­—ç¬¦ä¸²é•¿åº¦ã€‚</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>You choise - 1
	Use str
	good choise
123
	Result: 3
</code></pre></div><p>ç¬¬äºŒä¸ªé€‰é¡¹æ˜¾ç¤ºæœªå®ç°ã€‚</p><p>ç¬¬ä¸‰ä¸ªé€‰é¡¹ï¼šè¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå’Œä¸€ä¸ªæ•°å­—ï¼ŒæœåŠ¡ç«¯ç§»é™¤æœ«å°¾æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²åæ‰“å°å‡ºæ¥ã€‚</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>You choise - 3
	Use str int
	good choise
	Set string:
1234567
	Set number:
3
	Delete 3 ending symbols
	Result:
1234
</code></pre></div><h3 id=æ€è·¯>æ€è·¯</h3><p>æ—¢ç„¶æ˜¯æ— ELFæ–‡ä»¶çš„ç›²pwnï¼Œé‚£åªèƒ½æ‘¸ç€çŸ³å¤´è¿‡æ²³ã€‚åšé¢˜æ—¶æœ‰ä»¥ä¸‹å‡ ä¸ªå°è¯•ï¼š</p><ol><li><del>ä¸‰ä¸ªé€‰é¡¹çš„è¾“å…¥æ˜¯å¦æœ‰æº¢å‡ºï¼›</del></li><li><del>æœªå®ç°çš„é€‰é¡¹2æ˜¯å¦æœ‰éšè—åŠŸèƒ½ï¼›</del></li><li><del>é€‰é¡¹3è¾“å…¥çš„æ•°å­—æ˜¯å¦å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œå¯èƒ½é€ æˆå­—ç¬¦ä¸²æ‹·è´æ—¶çš„æº¢å‡ºæˆ–è€…æ³„å¯†é—®é¢˜ï¼›</del></li><li>&mldr;</li></ol><p>å¾ˆå¤šå°è¯•ä»¥å¤±è´¥å‘Šç»ˆã€‚æœ€ç»ˆæ‰¾åˆ°çš„æ¼æ´æ˜¯åŠŸèƒ½3çš„<strong>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</strong>ï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>You choise - 3
	Use str int
	good choise
	Set string:
%p %p %p
	Set number:
0
	Delete 3 ending symbols
	Result:
0xffe96350 0x8 0xf75fc1a4
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ„é€ ä¸€ä¸ªä»»æ„åœ°å€è¯»ï¼Œç„¶åæŠŠå†…å­˜ä¸­çš„ELF dumpä¸‹æ¥ã€‚</p><p>æ€ä¹ˆdumpï¼Ÿå¯ä»¥å‚è€ƒYouTubeä¸Šä¸€ä¸ªè§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=XuzuFUGuQv0">Format String to dump binary and gain RCE - 33c3ctf ESPR (pwn 150)</a>.</p><p>è¿™é“é¢˜å’ŒESPRæœ‰ä¸¤ç‚¹åŒºåˆ«ï¼š</p><ol><li>ESPRçš„è¾“å…¥åªé™åˆ¶äº†<code>\n</code>å­—ç¬¦ï¼Œä½†æ˜¯è¿™é¢˜çš„è¾“å…¥ä¸èƒ½åŒ…å«<code>\n</code>å’Œ<code>\x00</code>ï¼ŒçŒœæµ‹æ˜¯ç”¨äº†<code>fgets</code>å’Œ<code>strcpy</code>ã€‚æ‰€ä»¥åœ¨dumpä¸‹æ¥çš„äºŒè¿›åˆ¶ä¸­ä¼šæœ‰ä¸€äº›é—æ¼ä½ï¼Œä¸è¿‡å¯¹è¿™é“é¢˜æ¥è¯´æ— ä¼¤å¤§é›…ï¼›</li><li>ESPRä¸€ä¸ªè¿›ç¨‹å¾ªç¯ä¸æ–­è°ƒç”¨<code>printf</code>ï¼Œä½†æ˜¯è¿™é¢˜è¿›ç¨‹åªæœ‰ä¸€ä¸ªæµç¨‹ï¼Œæ²¡æœ‰å¾ªç¯ï¼Œæ‰€ä»¥éœ€è¦ä¸æ–­ä¸æœåŠ¡å™¨åˆ›å»ºè¿æ¥ï¼Œååˆ†è€—æ—¶ã€‚å¥½åœ¨éœ€è¦dumpçš„æ˜¯ELFï¼Œå†…å®¹æ˜¯å›ºå®šçš„ã€‚</li></ol><p>dumpè„šæœ¬ï¼š</p><code class=gist data-gist-id=cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa data-gist-file=strings-dump.py><p>Gist: <a href=https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa>cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></code><h3 id=æ¼æ´getsæº¢å‡º>æ¼æ´ï¼ˆgetsæº¢å‡ºï¼‰</h3><p>æŠŠELF dumpä¸‹æ¥ä¹‹åè·‘ä¸€ä¸‹<code>strings dump.raw</code>ï¼Œçœ‹åˆ°ä¸€äº›æœ‰æ„æ€çš„å­—ç¬¦ä¸²ï¼š</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ strings dump.raw
...
	Delete %i ending symbols
	Result:
https://ctf.bi.zone/files/babypwn
https://ctf.bi.zone/files/babylibc
main.c
Have a nice day!
ctfzone<span class=o>{</span>1t_1s_<span class=nv>$uP6r_F4k6_4H4H</span><span class=o>}</span>
ctfzone<span class=o>{</span><span class=nv>$uP6r_F4k6_4H4H4H_t00</span><span class=o>}</span>
...
</code></pre></div><p><del>é™¤äº†æœ‰ä¸¤è¡Œå‡è£…æ˜¯flagçš„ä¿¡æ¯ï¼Œè¿˜</del>æœ‰ä¸¤è¡ŒURLï¼Œçœ‹æ¥æ˜¯æä¾›äº†äºŒè¿›åˆ¶å’Œlibcçš„ï¼š</p><ol><li><a href=https://ctf.bi.zone/files/babypwn>https://ctf.bi.zone/files/babypwn</a></li><li><a href=https://ctf.bi.zone/files/babylibc>https://ctf.bi.zone/files/babylibc</a></li></ol><p>IDAæ‰“å¼€babypwnï¼Œå‘ç°mainå‡½æ•°è¿˜è—äº†ä¸¤ä¸ªèœå•é€‰é¡¹ï¼š</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>v3</span> <span class=o>=</span> <span class=n>_IO_getc</span><span class=p>(</span><span class=n>stdin</span><span class=p>);</span>
<span class=n>_IO_getc</span><span class=p>(</span><span class=n>stdin</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;1&#39;</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;2&#39;</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;3&#39;</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;X&#39;</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;T&#39;</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>==</span> <span class=sc>&#39;S&#39;</span> <span class=p>)</span>
<span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;You choise - %c</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>v3</span><span class=p>);</span>
  <span class=p>...</span>
	<span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>!=</span> <span class=sc>&#39;X&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>v3</span> <span class=o>!=</span> <span class=sc>&#39;T&#39;</span> <span class=p>)</span>
  <span class=p>...</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>Are you surprised?? (y or n)</span><span class=se>\r</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=n>gets</span><span class=p>(</span><span class=n>gets_buf</span><span class=p>);</span>
    <span class=n>v1</span> <span class=o>=</span> <span class=n>strchr</span><span class=p>(</span><span class=n>gets_buf</span><span class=p>,</span> <span class=sc>&#39;y&#39;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
      <span class=n>func_ptr</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>v2</span><span class=p>);</span>
</code></pre></div><p><code>gets</code>æ˜¯æ˜æ˜¾çš„å±é™©å‡½æ•°ï¼Œ<code>gets_buf</code>ä¸Šå­˜åœ¨æº¢å‡ºï¼Œå†çœ‹æº¢å‡ºåˆ°å“ªï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>.bss:080492E0 ; char gets_buf[256]
.bss:080492E0 gets_buf        db 100h dup(0)          ; DATA XREF: main+62â†‘o
.bss:080492E0                                         ; main+245â†‘o ...
.bss:080493E0 ; int (__cdecl *func_ptr)(_DWORD, _DWORD, _DWORD)
.bss:080493E0 func_ptr        dd 0                    ; DATA XREF: main+18Fâ†‘w
.bss:080493E0                                         ; main+1AEâ†‘w ...
</code></pre></div><p>å¯ä»¥ç›–åˆ°<code>func_ptr</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªæº¢å‡ºå·²ç»å¯ä»¥ç”¨æ¥<strong>åŠ«æŒæ§åˆ¶æµ</strong>äº†ã€‚</p><h3 id=exp>EXP</h3><p>checksecä¸€ä¸‹babypwnæ–‡ä»¶:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>[*] &#39;/tmp/babypwn&#39;
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
</code></pre></div><p>æœ‰RWXçš„æ®µï¼Œç”¨GDBæŒ‚ä¸ŠELFçœ‹ä¸€ä¸‹map:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>gef&gt; vmmap
Start      End        Offset     Perm Path
0x08048000 0x0804c000 0x00000000 rwx /tmp/babypwn
0x0804c000 0x0804d000 0x00000000 rw- [heap]
0xf7dbf000 0xf7f93000 0x00000000 r-x /usr/lib32/libc-2.27.so
0xf7f93000 0xf7f94000 0x001d4000 --- /usr/lib32/libc-2.27.so
...
</code></pre></div><p>æ•´ä¸ªELFéƒ½æ˜¯RWXçš„~~(è¿™é¢˜æœ‰æ¯’&mldr;)~~ï¼Œé‚£å¾ˆç®€å•äº†ï¼Œä¹‹å‰æº¢å‡ºçš„<code>gets_buf</code>å°±åœ¨bssæ®µä¸Šï¼Œå¯å†™å¯æ‰§è¡Œï¼Œè¿˜çŸ¥é“åœ°å€ã€‚åªè¦æŠŠshellcodeå†™åˆ°<code>gets_buf</code>ä¸Šï¼Œç„¶åæº¢å‡ºåˆ°<code>func_ptr</code>ï¼ŒæŒ‡å‘<code>gets_buf</code>ï¼Œå°±æ‰§è¡Œshellcodeäº†ã€‚</p><p>åˆ©ç”¨è„šæœ¬ï¼š</p><code class=gist data-gist-id=cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa data-gist-file=strings-exp.py><p>Gist: <a href=https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa>cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></code><h2 id=mobile-bank>Mobile Bank</h2><h3 id=é—®é¢˜-1>é—®é¢˜</h3><blockquote><p>We bring your attention to a new, unique product: &ldquo;Mobile Bank&rdquo;! It&rsquo;s a completely secure banking server running on mobile platforms. Now the Bank is in your pocket! <code>nc pwn-04.v7frkwrfyhsjtbpfcppnu.ctfz.one 1337</code></p><p><a href=https://ctf.bi.zone/files/mobile_bank.45115ff5f655d94fc26cb5244928b3fc>mobile_bank</a></p></blockquote><p>ä¸‹è½½äºŒè¿›åˆ¶ï¼Œchecksecä¸€ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>[*] &#39;/pwn/bank/mobile_bank&#39;
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)
</code></pre></div><p>æ˜¯ä¸€ä¸ªarm32çš„äºŒè¿›åˆ¶ã€‚ncè¿ä¸Šå»çœ‹æ˜¯ä»€ä¹ˆå†…å®¹ï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>         _._._                       _._._
        _|   |_                     _|   |_
        | ... |_._._._._._._._._._._| ... |
        | ||| |  o NATIONAL BANK o  | ||| |
        | &#34;&#34;&#34; |  &#34;&#34;&#34;    &#34;&#34;&#34;    &#34;&#34;&#34;  | &#34;&#34;&#34; |
   ())  |[-|-]| [-|-]  [-|-]  [-|-] |[-|-]|  ())
  (())) |     |---------------------|     | (()))
 (())())| &#34;&#34;&#34; |  &#34;&#34;&#34;    &#34;&#34;&#34;    &#34;&#34;&#34;  | &#34;&#34;&#34; |(())())
 (()))()|[-|-]|  :::   .-&#34;-.   :::  |[-|-]|(()))()
 ()))(()|     | |~|~|  |_|_|  |~|~| |     |()))(()
    ||  |_____|_|_|_|__|_|_|__|_|_|_|_____|  ||
 ~ ~^^ @@@@@@@@@@@@@@/=======\@@@@@@@@@@@@@@ ^^~ ~
      ^~^~                                ~^~^
*******************$$$Menu$$$*******************
* 1 - info                                     *
* 2 - set account id                           *
* 3 - set account note                         *
* 4 - make transaction                         *
* 5 - print account info                       *
* 6 - enable debug                             *
* 0 - exit                                     *
************************************************
Your choice:
</code></pre></div><p>è¿˜æ˜¯ä¸€é“èœå•é¢˜ã€‚å¤§æ¦‚æ„æ€æ˜¯è¿™æ˜¯ä¸€ä¸ªbankï¼Œé€‰é¡¹1æ‰“å°å½“å‰çš„è´¦æˆ·idå’Œdebugæ˜¯å¦å¼€å¯ï¼›é€‰é¡¹2è®¾ç½®å½“å‰æ“ä½œçš„è´¦æˆ·idï¼›é€‰é¡¹3è®¾ç½®è¿™ä¸ªè´¦æˆ·çš„noteï¼›é€‰é¡¹4ç»™å½“å‰è´¦æˆ·åŠ ä¸ŠæŒ‡å®šæ•°é¢çš„é‡‘é’±æ•°ï¼›é€‰é¡¹5æ‰“å°å½“å‰è´¦æˆ·çš„idã€è´¦æˆ·ä½™é¢ã€è´¦æˆ·noteï¼›é€‰é¡¹6æ‰“å¼€debugåŠŸèƒ½ã€‚</p><p>ç”¨IDAæ‰“å¼€ï¼Œçœ‹åˆ°æœ‰ä¸€ä¸ªé€‰é¡¹7ï¼Œ<code>debug_info</code>ï¼š</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c>      <span class=k>case</span> <span class=mi>7</span><span class=o>:</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>debug_enabled</span> <span class=p>)</span>
          <span class=n>debug_info</span><span class=p>();</span>
        <span class=k>else</span>
          <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Invalid command!&#34;</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
</code></pre></div><p>è¿™ä¸ªdebug_infoçš„åŠŸèƒ½æ˜¯ï¼Œæ‰“å°å‡ºæ‰€æœ‰16ä¸ªè´¦æˆ·çš„idã€ä½™é¢å’Œnote ã€‚</p><h3 id=æ¼æ´>æ¼æ´</h3><h4 id=1-account_idè¶Šç•Œ>1. account_idè¶Šç•Œ</h4><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>set_id</span><span class=p>()</span>
<span class=p>{</span>
  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// r0@1
</span><span class=c1></span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Enter account id: &#34;</span><span class=p>);</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>readint</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>result</span> <span class=o>&lt;=</span> <span class=mi>15</span> <span class=p>)</span>
    <span class=n>account_id</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
  <span class=k>else</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Wrong account id!&#34;</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>è¿™æ˜¯é€‰é¡¹2çš„å®ç°ï¼Œé€šè¿‡<code>readint</code>è¯»å…¥<code>int</code>å‹æ•°æ®ï¼Œè‹¥å°äº15ä¾¿èµ‹å€¼ç»™å…¨å±€å˜é‡<code>account_id</code>. æ¼æ´åœ¨äºè¿™é‡Œæ˜¯<strong>å¯ä»¥è¾“å…¥è´Ÿå€¼</strong>çš„ï¼Œè€Œè¿™ä¸ª<code>account_id</code>åœ¨å¤šä¸ªé€‰é¡¹ä¸­è¢«å½“ä½œæ•°ç»„ä¸‹æ ‡æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸‹è¶Šç•Œçš„é—®é¢˜ã€‚</p><p>è¿™ä¸ªæ¼æ´å¯ä»¥å®ç°ä»€ä¹ˆï¼Ÿæœ‰å››ç‚¹ï¼š</p><ol><li><strong>å—é™çš„ä»»æ„åœ°å€è¯»</strong>ï¼ˆé€‰é¡¹5ï¼‰ï¼›</li><li><strong>å—é™çš„ä»»æ„åœ°å€å†™</strong>ï¼ˆé€‰é¡¹4ï¼‰ï¼›</li><li>å—é™çš„ä»»æ„åœ°å€è¯»æŒ‡é’ˆå†…å®¹ï¼ˆé€‰é¡¹5ï¼‰ï¼›</li><li>å—é™çš„ä»»æ„åœ°å€èµ‹å€¼ä¸ºå †ä¸Šçš„æŒ‡é’ˆï¼ˆé€‰é¡¹3ï¼‰ã€‚</li></ol><p>3ã€4ä¸¤ç‚¹è¿™é‡Œç”¨å¤„ä¸å¤§ï¼Œæ‰€ä»¥ä¸è®²ã€‚è¿™é‡Œè®²ä¸‹1ã€2ä¸¤ç‚¹ã€‚è™½ç„¶é€šè¿‡è´Ÿå€¼çš„<code>account_id</code>å®ç°äº†ä¸€å®šç¨‹åº¦çš„ä»»æ„åœ°å€è¯»å†™ï¼Œä½†æ˜¯æ¯•ç«Ÿè¿˜æ˜¯å—é™çš„ã€‚</p><p>ä»¥ä¸‹æ˜¯é€‰é¡¹5çš„å®ç°ï¼š</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>account_info</span><span class=p>()</span>
<span class=p>{</span>
  <span class=kt>void</span> <span class=o>*</span><span class=n>v0</span><span class=p>;</span> <span class=c1>// r3@2
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// r0@4
</span><span class=c1></span>  <span class=kt>char</span> <span class=n>s</span><span class=p>;</span> <span class=c1>// [sp+Ch] [bp-158h]@4
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [sp+15Ch] [bp-8h]@1
</span><span class=c1></span>
  <span class=n>v3</span> <span class=o>=</span> <span class=n>_stack_chk_guard</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>notes_arr</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>account_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=p>)</span>
    <span class=n>v0</span> <span class=o>=</span> <span class=n>notes_arr</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>account_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
  <span class=k>else</span>
    <span class=n>v0</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>unk_1196C</span><span class=p>;</span>
  <span class=n>snprintf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=mh>0x150u</span><span class=p>,</span> <span class=s>&#34;id: %u, value: %d$, note:</span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>account_id</span><span class=p>,</span> <span class=n>notes_arr</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>account_id</span><span class=p>],</span> <span class=n>v0</span><span class=p>);</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>puts</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>!=</span> <span class=n>_stack_chk_guard</span> <span class=p>)</span>
    <span class=n>_stack_chk_fail</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><code>notes_arr</code>æ˜¯bssæ®µä¸Šçš„æ•°ç»„ï¼ŒåŸºå€æ˜¯0x22088ï¼Œè€Œè¾“å…¥çš„<code>account_id</code>å¿…é¡»è¦å°äºç­‰äº15ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹éœ€è¦è¯»å†™çš„åœ°å€addræœ‰3ç‚¹é™åˆ¶ï¼š</p><ol><li>addråˆ°0x22088çš„offsetå¿…é¡»æ˜¯<strong>8çš„å€æ•°</strong>ï¼›</li><li>addr+4çš„ä½ç½®<strong>å¿…é¡»ä¸º0</strong>æˆ–æ˜¯ä¸€ä¸ª<strong>åˆç†çš„æŒ‡é’ˆ</strong>ï¼›</li><li>é™¤éaddr<strong>å°äº<code>notes_arr</code>çš„åœ°å€</strong>ï¼ˆæ¯”å¦‚GOTã€.textã€.dataæ®µï¼‰ï¼Œä¸ç„¶addrçš„å€¼ä¸èƒ½å¤ªå°ï¼Œ<code>addr - notes_arr</code>çš„å€¼åœ¨<strong>æ— ç¬¦å·int32ä¸Šå¿…é¡»è¡¨ç°ä¸ºè´Ÿæ•°</strong>ã€‚</li></ol><h4 id=2-debug_infoè¶Šç•Œå†™>2. debug_infoè¶Šç•Œå†™</h4><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>debug_info</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>size_t</span> <span class=n>n</span><span class=p>;</span> <span class=c1>// ST14_4@4
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v1</span><span class=p>;</span> <span class=c1>// r3@5
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// r0@6
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v3</span><span class=p>;</span> <span class=c1>// [sp+Ch] [bp-218h]@1
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v4</span><span class=p>;</span> <span class=c1>// [sp+Ch] [bp-218h]@3
</span><span class=c1></span>  <span class=kt>signed</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [sp+10h] [bp-214h]@1
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v6</span><span class=p>;</span> <span class=c1>// [sp+18h] [bp-20Ch]@3
</span><span class=c1></span>  <span class=kt>char</span> <span class=n>s</span><span class=p>;</span> <span class=c1>// [sp+1Ch] [bp-208h]@1
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// [sp+21Ch] [bp-8h]@1
</span><span class=c1></span>
  <span class=n>v8</span> <span class=o>=</span> <span class=n>_stack_chk_guard</span><span class=p>;</span>
  <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x200u</span><span class=p>);</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>15</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>v4</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>v3</span><span class=p>[</span><span class=n>snprintf</span><span class=p>(</span><span class=n>v3</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v8</span> <span class=o>-</span> <span class=n>v3</span><span class=p>,</span> <span class=s>&#34;%u</span><span class=se>\t</span><span class=s>%d$</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>notes_arr</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>i</span><span class=p>])];</span>
    <span class=n>v6</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>notes_arr</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v6</span> <span class=p>)</span>
    <span class=p>{</span>
      <span class=n>n</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>v6</span><span class=p>);</span>
      <span class=n>memcpy</span><span class=p>(</span><span class=n>v4</span><span class=p>,</span> <span class=n>v6</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
      <span class=n>v4</span> <span class=o>+=</span> <span class=n>n</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>v1</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
    <span class=n>v3</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
    <span class=o>*</span><span class=n>v1</span> <span class=o>=</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
  <span class=p>}</span>
</code></pre></div><p><code>debug_info</code>ç›´æ¥æ‹¿<code>snprintf</code>è¿”å›å€¼åšæ•°ç»„ä¸‹æ ‡ï¼Œç§»åŠ¨v3æŒ‡é’ˆã€‚è¿™æ˜¯å¯¹<code>snprintf</code>è¿”å›å€¼çš„ä¸€ä¸ªå…¸å‹è¯¯ç”¨ã€‚</p><blockquote><p>RETURN VALUE</p><p>The functions snprintf() and vsnprintf() do not write more than size bytes (including the terminating null byte ('\0')). If the output was truncated due to this limit, then the return value is the number of characters (excluding the terminating null byte) which <strong>would have been</strong> written to the final string if enough space had been available. Thus, a return value of size or more means that the output was truncated. (See also below under NOTES.)</p></blockquote><p>çœ‹manæ–‡æ¡£å…¶å®å°±å¯ä»¥å‘ç°ï¼Œsnprintfè¿”å›çš„ä¸æ˜¯å®é™…å¾€ç›®æ ‡bufé‡Œå†™äº†å¤šå°‘å­—èŠ‚ï¼Œè€Œæ˜¯<strong>æœ¬åº”å†™å¤šå°‘å­—èŠ‚</strong>ã€‚è¿™ä¸ªæ¼æ´åˆ©ç”¨åå…¶å®å¯ä»¥<strong>è¶Šè¿‡stack cookie</strong>å†™å€¼ï¼Œ<strong>ç»•è¿‡canaryä¿æŠ¤</strong>ï¼Œå®ç°<strong>ROP</strong>æ”»å‡»ã€‚ä½†æ˜¯<strong>bufä¸­ä¸èƒ½å‡ºç°null byte</strong>ï¼Œè€Œä¸”æˆ‘å¯¹ARMä¸‹çš„ROPä¸ç†Ÿï¼Œæ‰€ä»¥è¿™ä¸ªæ€è·¯åœ¨èµ›é—´åªæ˜¯ä¸ªå¤‡é€‰é¡¹ã€‚</p><p><strong>P.S.</strong> è¿™ä¸ªdebugé€‰é¡¹å¯ä»¥é€šè¿‡ä¸Šæ–‡çš„ã€Œå—é™çš„ä»»æ„åœ°å€èµ‹å€¼ä¸ºå †ä¸Šçš„æŒ‡é’ˆã€æ¥æ‰“å¼€ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p><strong>P.S.S.</strong> å…¶å®æˆ‘ç”¨qemuè°ƒè¿™ä¸ªäºŒè¿›åˆ¶çš„æ—¶å€™ï¼Œå‘ç°stackæ˜¯rwxï¼ˆå¯å†™å¯æ‰§è¡Œï¼‰çš„~~ï¼ˆè¿™ä¸ªæ¯”èµ›çœŸçš„æœ‰æ¯’ã€‚ã€‚ã€‚ï¼‰~~ã€‚ä½†æ˜¯å¦‚æœæƒ³è¦leakæ ˆåœ°å€ï¼Œå…¶å®è¿˜æ˜¯éœ€è¦ä¸€ä¸ªä»»æ„åœ°å€è¯»ã€‚å¯æ˜¯å›è¿‡å¤´æ¥ï¼Œå¦‚æœæœ‰äº†ä»»æ„åœ°å€è¯»ï¼Œè¿˜éœ€è¦åšROPè¿™ä¹ˆå¤æ‚çš„åˆ©ç”¨å—ï¼Ÿ</p><h3 id=exp-1>EXP</h3><p>æˆ‘çš„åˆ©ç”¨æ€è·¯ä¸ªäººæ„Ÿè§‰æ¯”è¾ƒæ¸…å¥‡ï¼Œéœ€è¦ç»•ä¸ªå°å¼¯ï¼Œæ˜¯åœ¨æ´—æ¾¡çš„æ—¶å€™æƒ³å‡ºæ¥çš„~~ï¼ˆåˆä¸€æ¬¡ï¼‰~~ã€‚</p><p>è¿™ä¸ªåˆ©ç”¨åªç”¨åˆ°äº†<code>account_id</code>è¶Šç•Œè¿™ä¸ªæ¼æ´ï¼Œå…·ä½“æ­¥éª¤æ˜¯ï¼š</p><ol><li>é€šè¿‡å—é™çš„ä»»æ„åœ°å€è¯»ï¼Œè¯»<code>memcmp_got</code>çš„å€¼ï¼ˆä¸ç®¡æ˜¯ä¸æ˜¯å·²ç»è¢«<code>dl-resolve</code>äº†ï¼Œåªæ˜¯éœ€è¦è¿™ä¸ªå€¼æ¥è®¡ç®—å·®å€¼ï¼‰ï¼›</li><li>é€šè¿‡å—é™çš„ä»»æ„åœ°å€å†™ï¼ŒæŠŠ<code>printf_plt</code>çš„å€¼å†™åˆ°<code>memcmp_got</code>ä¸Šå»ï¼ˆè¿™ä¸€æ­¥éœ€è¦è®¡ç®—<code>memcmp_got</code>åˆ°<code>printf_plt</code>çš„å·®å€¼ï¼‰ï¼Œ<strong>æ­¤æ—¶memcmpå·²ç»å˜æˆäº†printf</strong>ï¼›</li><li>é€‰é¡¹6çš„<code>enable_debug</code>å‡½æ•°ç”¨åˆ°äº†memcmpï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿™é‡Œ<del>å¼ºè¡Œ</del>æ„é€ äº†ä¸€ä¸ªFSBæ¼æ´ï¼Œå¯ä»¥ç²¾å¿ƒæ„é€ Format Stringæ¥å®ç°ä»»æ„åœ°å€è¯»ï¼š</li><li>åˆ©ç”¨pwntoolsçš„DynELFå·¥å…·ï¼Œç»“åˆåœ¨<code>enable_debug</code>æ„é€ çš„ä»»æ„åœ°å€è¯»ï¼ˆå³leakï¼‰ï¼Œæ³„å¯†libcä¸Šçš„<code>system</code>å‡½æ•°åœ°å€ï¼›</li><li>é€šè¿‡å—é™çš„ä»»æ„åœ°å€å†™ï¼Œå°†<code>system</code>å‡½æ•°åœ°å€å†™åˆ°<code>memcmp_got</code>ä¸Šï¼Œè°ƒç”¨<code>enable_debug</code>ï¼Œä¼ å…¥<code>/bin/sh</code>ï¼Œgetshell.</li></ol><p>exp.py:</p><code class=gist data-gist-id=cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa data-gist-file=bank-exp.py><p>Gist: <a href=https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa>cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></code></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments ğŸ’¬" theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>Â© 2014 - 2018</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/main.min.5ceea6265a37f2acfd2c3e4aa33851d393557087bf45cfeaa33cef7c60579601d3824d98164dd7124e18da9698807579b6233e6d173f28d0d34adfebc133494a.js async></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubl.in/ga-proxy/"</script><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3 async></script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.pwn.ooo/umami.js></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script></body></html>