<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>C Programming Tricks - /home/cubl</title><meta property="og:title" content="C Programming Tricks - /home/cubl"><link href=https://cubl.in/favicon.ico rel=icon type=image/x-icon><meta name=description content="C, GCC"><link rel=stylesheet href=/css/main.min.3bcbe33ae5c46485bcebc6352fc91232f950eb735ccac53f81bd19d79251ba9c.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>C Programming Tricks</h1><span class=article-date>2015-05-02</span>
<a class=article-tag href=/tags/c>C</a>
<a class=article-tag href=/tags/gcc>GCC</a><div class=article-content><p>这个 Note 用来记录各处收集的 C 编程 tricks. 看到有意思的就会摘一下，来源各异。</p><h2 id=anonymous-arrays>Anonymous arrays</h2><p>C99 offers some really cool stuff using anonymous arrays:</p><h3 id=removing-pointless-variables>Removing pointless variables</h3><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>yes</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
<span class=n>setsockopt</span><span class=p>(</span><span class=n>yourSocket</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>yes</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
<span class=cm>/* becomes: */</span>
<span class=n>setsockopt</span><span class=p>(</span><span class=n>yourSocket</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>[]){</span><span class=mi>1</span><span class=p>},</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</code></pre></div><h3 id=passing-a-variable-amount-of-arguments>Passing a Variable Amount of Arguments</h3><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>Void</span> <span class=nf>func</span><span class=p>(</span><span class=n>type</span><span class=o>*</span> <span class=n>values</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>while</span><span class=p>(</span><span class=o>*</span><span class=n>values</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>x</span> <span class=o>=</span> <span class=o>*</span><span class=n>values</span><span class=o>++</span><span class=p>;</span>
        <span class=cm>/* do whatever with x */</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=n>func</span><span class=p>((</span><span class=n>type</span><span class=p>[]){</span><span class=n>val1</span><span class=p>,</span><span class=n>val2</span><span class=p>,</span><span class=n>val3</span><span class=p>,</span><span class=n>val4</span><span class=p>,</span><span class=mi>0</span><span class=p>});</span>
</code></pre></div><h3 id=static-linked-lists>Static linked lists</h3><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=n>llist</span> <span class=p>{</span> <span class=kt>int</span> <span class=n>a</span><span class=p>;</span> <span class=k>struct</span> <span class=n>llist</span><span class=o>*</span> <span class=n>next</span><span class=p>;};</span>
    <span class=cp>#define cons(x,y) (struct llist[]){ {x,y} }
</span><span class=cp></span>    <span class=k>struct</span> <span class=n>llist</span> <span class=o>*</span><span class=n>list</span><span class=o>=</span><span class=n>cons</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>cons</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>cons</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>cons</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>))));</span>
    <span class=k>struct</span> <span class=n>llist</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>list</span><span class=p>;</span>
    <span class=k>while</span><span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>);</span>
      <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2 id=include-data-file-as-header-inside-array-initializer>Include data file as header inside array initializer</h2><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>double</span> <span class=n>normals</span><span class=p>[][]</span> <span class=o>=</span> <span class=p>{</span>
  <span class=cp>#include</span> <span class=cpf>&#34;normals.txt&#34;</span><span class=cp>
</span><span class=cp></span><span class=p>};</span>
</code></pre></div><h2 id=using-__file__-and-__line__-for-debugging>Using <code>__FILE__</code> and <code>__LINE__</code> for debugging</h2><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define WHERE fprintf(stderr,&#34;[LOG]%s:%d\n&#34;,__FILE__,__LINE__);
</span></code></pre></div><h2 id=dynamically-sized-objectmodified>Dynamically sized object(modified)</h2><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>struct</span> <span class=n>X</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
    <span class=kt>char</span> <span class=n>str</span><span class=p>[];</span>
<span class=p>};</span>

<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
<span class=k>struct</span> <span class=n>X</span> <span class=o>*</span><span class=n>string</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>X</span><span class=p>,</span> <span class=n>str</span><span class=p>)</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
<span class=n>strcpy</span><span class=p>(</span><span class=n>string</span><span class=o>-&gt;</span><span class=n>str</span><span class=p>,</span> <span class=s>&#34;hello world&#34;</span><span class=p>);</span>
<span class=n>string</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>=</span> <span class=n>n</span><span class=p>;</span>
</code></pre></div><p><code>offsetof()</code> 本身也是一个比较有趣的宏定义(?)。</p><h2 id=an-example-of-offsetof>An example of <code>offsetof()</code></h2><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define offsetof(st, m) ((size_t)(&amp;((st *)0)-&gt;m))
</span></code></pre></div><p>This works by casting a null pointer into a pointer to structure st, and then obtaining the address of member m within said structure. While this implementation works correctly in many compilers, it has undefined behavior according to the C standard,[2] since it involves a dereference of a null pointer (although, one might argue that no dereferencing takes place, because the whole expression is calculated at compile time). It also tends to produce confusing compiler diagnostics if one of the arguments is misspelled.</p><h2 id=blank-in-a-scanf-format>Blank in a <code>scanf()</code> format</h2><p>In a <code>scanf()</code> format, a blank, tab or newline means &lsquo;skip white space if there is any to skip&rsquo;. It does not directly &lsquo;clear the input buffer&rsquo;, but it does eat any white space which looks similar to clearing the input buffer (but is quite distinct from that). If you&rsquo;re on Windows, using <code>fflush(stdin)</code> clears the input buffer (of white space and non-white space characters); on Unix and according to the C standard, <code>fflush(stdin)</code> is undefined behaviour.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>while</span><span class=p>((</span><span class=n>c</span> <span class=o>=</span> <span class=n>getchar</span><span class=p>())</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=p>);</span>
<span class=cm>/* becomes: */</span>
<span class=n>scanf</span><span class=p>(</span><span class=s>&#34; %c&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>);</span>
</code></pre></div><h2 id=reference>Reference</h2><ol><li><a href=http://stackoverflow.com/questions/599365/what-is-your-favorite-c-programming-trick>What is your favorite C programming trick? - StackOverflow</a></li><li><a href=https://en.wikipedia.org/wiki/Offsetof>offsetof() - Wikipedia</a></li><li><a href=http://stackoverflow.com/questions/18491390/difference-between-scanfc-c-and-scanf-c-c>Difference between scanf("%c", &c) and scanf(" %c", &c) - StackOverflow</a></li></ol></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments 💬" theme=boxy-light crossorigin=anonymous async defer></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2015</a></li></ul></footer></div><script async src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/async.min.f0ee05a5180b84c9031dc6048a165e3238369671eaac5df72f9fc961a2bb03f78685ba489261432234bcbad8b66c86ffa90cffd19f60c4b28ef06e677fc9763f.js onload=window.GistEmbed.init()></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubl.in/ga-proxy/"</script><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3 async defer></script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.pwn.ooo/umami.js></script></body></html>