<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>vpn-udp-libev 开发总结 - /home/cubl</title><meta property="og:title" content="vpn-udp-libev 开发总结 - /home/cubl"><link href=/favicon.ico rel=icon type=image/x-icon><link rel=stylesheet href=/css/main.min.9ae39f94818f4da457a6d1bcb86758258559067c36817f968ab59ae3c5c39b4bb6b793e3de3d4cc608ab8e1e4d178f67f70ad266ed0fadfae98939fab0d30b92.css integrity="sha512-muOflIGPTaRXptG8uGdYJYVZBnw2gX+WirWa48XDm0u2t5Pj3j1Mxgirjh5NF49n9wrSZu0PrfrpiTn6sNMLkg==" media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>vpn-udp-libev 开发总结</h1><span class=article-date>2015-01-09</span>
<a class=article-tag href=/tags/network>Network</a>
<a class=article-tag href=/tags/vpn>VPN</a>
<a class=article-tag href=/tags/linux>Linux</a><div class=article-content><p>最近又在看 UNIX 网络编程那本书，写了个 vpn 练手，代码和简单的介绍在 <a href=https://github.com/cubarco/network-programming-exp/tree/master/vpn-udp-libev title=cubarco/network-programming-exp/vpn-udp-libev>Github</a> 上<s>(好像效率还不错的样子)</s>。这里照例做一下总结，便于以后查阅。</p><h2 id=关于recvfrom>关于<code>recvfrom()</code></h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#998;font-style:italic>/* recvfrom() 的声明 */</span>
ssize_t <span style=color:#900;font-weight:700>recvfrom</span>(<span style=color:#458;font-weight:700>int</span> sockfd, <span style=color:#458;font-weight:700>void</span> <span style=color:#000;font-weight:700>*</span>buf, size_t len, <span style=color:#458;font-weight:700>int</span> flags,
                 <span style=color:#000;font-weight:700>struct</span> sockaddr <span style=color:#000;font-weight:700>*</span>src_addr, socklen_t <span style=color:#000;font-weight:700>*</span>addrlen);
</code></pre></td></tr></table></div></div><p>这个函数比较诡异的是它的最后一个参数<code>addrlen</code>.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>If  src_addr  is  not  NULL, and the underlying protocol provides the source
address of the message, that source address is placed in the buffer  pointed
to  by  src_addr.  In this case, addrlen is a value-result argument.  Before
the call, it should be initialized to the size of the buffer associated with
src_addr.  Upon return, addrlen is updated to contain the actual size of the
source address.  The returned address is truncated if the buffer provided is
too  small;  in this case, addrlen will return a value greater than was sup‐
plied to the call.
</code></pre></td></tr></table></div></div><p>一开始用的时候没有仔细看 manpage，天真地以为既然传的是指针，它的用处应该就只储存返回值。但是昨天跟 @hexchain juju讨论之后，发现这个函数还是会用到<code>addrlen</code>的初始值的,目的大概是为了防止给<code>src_addr</code>传值的时候溢出。以后用库函数还是先查清楚参数的具体用处再用吧&mldr;</p><h2 id=同时兼容-ipv4-和-ipv6>同时兼容 IPv4 和 IPV6</h2><p>服务器为了同时兼容两种协议，主要就是 addr 结构体的选择，<code>sockaddr_in</code>是为 IPv4 准备的，在我 x64 系统上它的结构体大小是 16B，而<code>sockaddr_in6</code>是为 IPv6 准备的，大小是28B，一开始我以为<code>sockaddr</code>是兼容二者的结构体，但是这货大小只有16B。在<a href=https://github.com/clowwindy/ShadowVPN title=ShadowVPN>ShadowVPN</a>代码里找了找，发现<code>sockaddr_storage</code>这个结构体，据说是兼容了所有 addr 结构，包括最大的 UNIX 套接字，大小有 128B。然后具体到 IP 地址的转换，可以用<code>inet_pton()</code>这个兼容两种IP协议的函数。</p><h2 id=关于-mtu>关于 MTU</h2><p>之前对 MTU 一直是云里雾里的，这次算是对它有了一点了解。<a href=http://en.wikipedia.org/wiki/Maximum_transmission_unit>MTU(Maximum transmission unit)</a>指的就是通讯协议的<code>DATA</code>块的最大容量。一个 link 的 MTU 决定了通过它的 IP 包的最大体积。所以设置一个 tunnel 设备的 MTU 可以确保这些 IP 包在套上另一层 UDP + IP 的 header 之后不会被超出 MTU 被 fragment.</p><h2 id=关于压缩>关于压缩</h2><p>最大(无损)压缩比例决定于信息熵。所以用<code>dd if=/dev/urandom bs=1M count=100 | gzip - | wc -c</code>这种方式测试压缩比例的结果往往是压缩比例大于1&mldr;</p><h2 id=more>More</h2><p>想到再写</p></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank>Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2015</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js async></script><script src=/js/main.min.c0265b880e16484a6541ce80355a1ae627d6edcece7e9f5e5a47848c6776dae31c76328b55a8531b625aaf4315dcec7fdf695e3d044d3c19b918e21490e323e5.js integrity="sha512-wCZbiA4WSEplQc6ANVoa5ifW7c7Ofp9eWkeEjGd22uMcdjKLVahTG2Jar0MV3Ox/32lePQRNPBm5GOIUkOMj5Q==" async></script></body></html>