<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>vpn-udp-libev 开发总结 - /home/cubl</title><meta property="og:title" content="vpn-udp-libev 开发总结 - /home/cubl"><link href=/favicon.ico rel=icon type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/css/main.min.9861353c7baacf2268a74fe7ea9d3bd8211eada1554a630c4d29fb448bfae5fb8f43ea02baa52d2ca079d0027f37aa8f058ab0362f4301e9a9b77538d71b549b.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>vpn-udp-libev 开发总结</h1><span class=article-date>2015-01-09</span>
<a class=article-tag href=/tags/network>Network</a>
<a class=article-tag href=/tags/vpn>VPN</a>
<a class=article-tag href=/tags/linux>Linux</a><div class=article-content><p>最近又在看 UNIX 网络编程那本书，写了个 vpn 练手，代码和简单的介绍在 <a href=https://github.com/cubarco/network-programming-exp/tree/master/vpn-udp-libev title=cubarco/network-programming-exp/vpn-udp-libev>Github</a> 上(好像效率还不错的样子)。这里照例做一下总结，便于以后查阅。</p><h2 id=关于recvfrom>关于<code>recvfrom()</code></h2><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cm>/* recvfrom() 的声明 */</span>
<span class=n>ssize_t</span> <span class=nf>recvfrom</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span>
                 <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>src_addr</span><span class=p>,</span> <span class=n>socklen_t</span> <span class=o>*</span><span class=n>addrlen</span><span class=p>);</span>
</code></pre></div><p>这个函数比较诡异的是它的最后一个参数<code>addrlen</code>.</p><div class=highlight><pre class=chroma><code class=language-plain data-lang=plain>If  src_addr  is  not  NULL, and the underlying protocol provides the source
address of the message, that source address is placed in the buffer  pointed
to  by  src_addr.  In this case, addrlen is a value-result argument.  Before
the call, it should be initialized to the size of the buffer associated with
src_addr.  Upon return, addrlen is updated to contain the actual size of the
source address.  The returned address is truncated if the buffer provided is
too  small;  in this case, addrlen will return a value greater than was sup‐
plied to the call.
</code></pre></div><p>一开始用的时候没有仔细看 manpage，天真地以为既然传的是指针，它的用处应该就只储存返回值。但是昨天跟 @hexchain juju讨论之后，发现这个函数还是会用到<code>addrlen</code>的初始值的,目的大概是为了防止给<code>src_addr</code>传值的时候溢出。以后用库函数还是先查清楚参数的具体用处再用吧&mldr;</p><h2 id=同时兼容-ipv4-和-ipv6>同时兼容 IPv4 和 IPV6</h2><p>服务器为了同时兼容两种协议，主要就是 addr 结构体的选择，<code>sockaddr_in</code>是为 IPv4 准备的，在我 x64 系统上它的结构体大小是 16B，而<code>sockaddr_in6</code>是为 IPv6 准备的，大小是28B，一开始我以为<code>sockaddr</code>是兼容二者的结构体，但是这货大小只有16B。在<a href=https://github.com/clowwindy/ShadowVPN title=ShadowVPN>ShadowVPN</a>代码里找了找，发现<code>sockaddr_storage</code>这个结构体，据说是兼容了所有 addr 结构，包括最大的 UNIX 套接字，大小有 128B。然后具体到 IP 地址的转换，可以用<code>inet_pton()</code>这个兼容两种IP协议的函数。</p><h2 id=关于-mtu>关于 MTU</h2><p>之前对 MTU 一直是云里雾里的，这次算是对它有了一点了解。<a href=http://en.wikipedia.org/wiki/Maximum_transmission_unit>MTU(Maximum transmission unit)</a>指的就是通讯协议的<code>DATA</code>块的最大容量。一个 link 的 MTU 决定了通过它的 IP 包的最大体积。所以设置一个 tunnel 设备的 MTU 可以确保这些 IP 包在套上另一层 UDP + IP 的 header 之后不会被超出 MTU 被 fragment.</p><h2 id=关于压缩>关于压缩</h2><p>最大(无损)压缩比例决定于信息熵。所以用<code>dd if=/dev/urandom bs=1M count=100 | gzip - | wc -c</code>这种方式测试压缩比例的结果往往是压缩比例大于1&mldr;</p><h2 id=more>More</h2><p>想到再写</p></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2015</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js async></script><script src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/main.min.60d77477267181e7581bba5435ded18ab8ff1db3955dde2d3afeec25cc51d24e32b178b6c1ebb5edc2a4cef04c8f592408eb2811f0c78c9295b8a0939977a6a1.js async></script></body></html>