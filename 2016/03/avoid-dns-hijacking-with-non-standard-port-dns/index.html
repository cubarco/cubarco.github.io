<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>利用非标准端口 DNS 服务器避免 DNS 劫持 - /home/cubl</title><meta property="og:title" content="利用非标准端口 DNS 服务器避免 DNS 劫持 - /home/cubl"><link href=https://cubl.in/favicon.ico rel=icon type=image/x-icon><meta name=description content="Linux, DNS, GFW, Dnsmasq, OpenDNS"><link rel=stylesheet href=/css/main.min.39d87073ffff84c35a9b5d21e8b94ef0643a51af7a909c6f3d506433db4442a1.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>利用非标准端口 DNS 服务器避免 DNS 劫持</h1><span class=article-date>2016-03-23</span>
<a class=article-tag href=/tags/linux>Linux</a>
<a class=article-tag href=/tags/dns>DNS</a>
<a class=article-tag href=/tags/gfw>GFW</a>
<a class=article-tag href=/tags/dnsmasq>Dnsmasq</a>
<a class=article-tag href=/tags/opendns>OpenDNS</a><div class=article-content><blockquote><p>GFW的DNS劫持原理: 说起来挺简单,GFW对境外DNS的劫持,是在发现你请求敏感域名的DNS记录时,伪装成你请求的DNS返回一个污染的数据包给你的解析器,但并不会丢弃你向境外DNS的请求,也不会丢弃境外DNS返回的正确解析结果,他只是让错误的数据抢先回来欺骗了你的解析器而已,毕竟他直接从国内给你发污染数据怎么都比国外DNS返回正确数据要快.而解析器在先收到了欺骗数据包之后,就不会再管后面返回的正确数据了,这样你就被 DNS劫持了.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p></blockquote><p>很久以前我是用这篇 blog<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>提供的方法，就是用 iptables drop 掉 GFW 的假 DNS 解析包。但是 2015 年 GFW 开始采用随机 IP 污染的方式，这种黑名单的解决方案已经不可用了。后来换了 <a href=https://github.com/jedisct1/dnscrypt-proxy>dnscrypt-proxy</a>，还算是比较好用的。但是最近不明原因，dnscrypt-proxy 在使用一段时间之后老是卡住。尝试解决无果，就想办法找替代的方案。</p><p>前几天发现 GFW 没有劫持非标准端口的 DNS 服务器，于是想到了下面两种方法避免劫持。</p><h2 id=iptables>iptables</h2><p>将外网网卡(我这是 enp8s0)发出的 dport 是 53 的包 DNAT 给 OpenDNS 443 端口。</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>iptables -t nat -A OUTPUT -o enp8s0 -p udp --dport <span class=m>53</span> <span class=se>\
</span><span class=se></span>    -j DNAT --to 208.67.222.222:443
</code></pre></div><h2 id=dnsmasq>dnsmasq</h2><p>以下是采用 OpenDNS 443 端口的示例配置。</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>port=53
no-resolv
# For IPv6
# server=2620:0:ccc::2#443
server=208.67.222.222#443
listen-address=127.0.0.1
</code></pre></div><p>Dnsmasq 的具体使用，可以看 ArchWiki<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><h2 id=update-2016-05-15>Update: 2016-05-15</h2><p>推荐结合 @felixonmars 的 <a href=https://github.com/felixonmars/dnsmasq-china-list>dnsmasq-china-list</a> 使用。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://www.lifetyper.com/2014/06/anti-dns-poison-without-vpn.html>无需VPN的OpenWRT DNS防污染方法</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://wiki.archlinux.org/index.php/Dnsmasq>dnsmasq @ ArchWiki</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments 💬" theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2016</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/main.min.4f8f8d57bd4e088a41d6e3c416a7b1b7a009a40cdf08a064e67009327d2f750ad369fc07c6e43cfac03a8353cb05429a56004a0aed7a3243501ef6ac3cd5b1a0.js async></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubl.in/ga-proxy/"</script><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3 async></script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.pwn.ooo/umami.js></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script></body></html>