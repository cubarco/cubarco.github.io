<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>[转] C中的可变参数研究 - /home/cubarco</title><meta property="og:title" content="[转] C中的可变参数研究 - /home/cubarco"><link href=https://cubar.co/favicon.ico rel=icon type=image/x-icon><meta name=description content="C"><link rel=stylesheet href=/css/main.min.3bcbe33ae5c46485bcebc6352fc91232f950eb735ccac53f81bd19d79251ba9c.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/links/>Links</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>[转] C中的可变参数研究</h1><span class=article-date>2014-02-25</span>
<a class=article-tag href=/tags/c>C</a><div class=article-content><p><em><del>初学C，感觉可变参数挺好玩的，转载一发做个mark。本想注明来源，发现来源也是转载的，找不到根源，就不贴链接了。</del></em></p><h3 id=一-何谓可变参数>一. 何谓可变参数</h3><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>printf</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>format</span><span class=p>,</span> <span class=p>...);</span>
</code></pre></div><p>这是使用过C语言的人所再熟悉不过的printf函数原型，它的参数中就有固定参数format和可变参数（用”…”表示）.   而我们又可以用各种方式来调用printf,如:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=n>value</span><span class=p>);</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span><span class=n>str</span><span class=p>);</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;the number is %d,string is: %s&#34;</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</code></pre></div><h3 id=二-实现原理>二. 实现原理</h3><p>C语言用宏来处理这些可变参数。这些宏看起来很复杂，其实原理挺简单，就是根据参数入栈的特点从最靠近第一个可变参数的固定参数开始，依次获取每个可变参数的地址。下面我们来分析这些宏。在VC中的stdarg.h头文件中，针对不同平台有不同的宏定义，我们选取X86平台下的宏定义：</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=kt>char</span> <span class=o>*</span><span class=n>va_list</span><span class=p>;</span>
<span class=cm>/*把va_list被定义成char*，这是因为在我们目前所用的PC机上，字符指针类型可以用来存储内存单元地址。而在有的机器上va_list是被定义成void*的*/</span>
<span class=cp>#define _INTSIZEOF(n) ((sizeof(n) + sizeof(int) - 1) &amp; ~(sizeof(int) - 1))
</span><span class=cp></span><span class=cm>/*_INTSIZEOF(n)宏是为了考虑那些内存地址需要对齐的系统，从宏的名字来应该是跟sizeof(int)对齐。一般的sizeof(int)=4，也就是参数在内存中的地址都为4的倍数。比如，如果sizeof(n)在1－4之间，那么_INTSIZEOF(n)＝4；如果sizeof(n)在5－8之间，那么_INTSIZEOF(n)=8。*/</span>
<span class=cp>#define va_start(ap,v)(ap = (va_list)&amp;v + _INTSIZEOF(v))
</span><span class=cp></span><span class=cm>/*va_start的定义为 &amp;v+_INTSIZEOF(v), 这里&amp;v是最后一个固定参数的起始地址，再加上其实际占用大小后，就得到了第一个可变参数的起始内存地址。所以我们运行va_start(ap, v)以后,ap指向第一个可变参数在的内存地址*/</span>
<span class=cp>#define va_arg(ap,t) (*(t*)((ap += _INTSIZEOF(t)) - _INTSIZEOF(t)))
</span><span class=cp></span><span class=cm>/*这个宏做了两个事情，
</span><span class=cm>①用用户输入的类型名对参数地址进行强制类型转换，得到用户所需要的值
</span><span class=cm>②计算出本参数的实际大小，将指针调到本参数的结尾，也就是下一个参数的首地址，以便后续处理。*/</span>
<span class=cp>#define va_end(ap) (ap = (va_list)0)
</span><span class=cp></span><span class=cm>/*x86平台定义为ap=(char*)0;使ap不再指向堆栈,而是跟NULL一样.有些直接定义为((void*)0),这样编译器不会为va_end产生代码,例如gcc在linux的x86平台就是这样定义的.在这里大家要注意一个问题:由于参数的地址用于va_start宏,所以参数不能声明为寄存器变量或作为函数或数组类型.*/</span>
</code></pre></div><p>以下再用图来表示~~(这什么破图)~~:</p><p>在VC等绝大多数C编译器中，默认情况下，参数进栈的顺序是由右向左的，因此，参数进栈以后的内存模型如下图所示：最后一个固定参数的地址位于第一个可变参数之下，并且是连续存储的。</p><h3 id=三-printf研究>三. printf研究</h3><p>下面是一个简单的printf函数的实现。<del>（作者简直是幽默，所谓printf函数的实现里面居然用到了printf函数。。。）</del></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&#34;stdio.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;stdlib.h&#34;</span><span class=cp>
</span><span class=cp></span><span class=kt>void</span> <span class=nf>myprintf</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span> <span class=c1>//一个简单的类似于printf的实现,参数必须都是int类型
</span><span class=c1></span><span class=p>{</span>
<span class=kt>char</span><span class=o>*</span> <span class=n>pArg</span><span class=o>=</span><span class=nb>NULL</span><span class=p>;</span>   <span class=c1>//等价于原来的va_list
</span><span class=c1></span><span class=kt>char</span> <span class=n>c</span><span class=p>;</span>

<span class=n>pArg</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>fmt</span><span class=p>;</span>   <span class=c1>//注意不要写成p = fmt, 因为这里要对参数取址，而不是取值
</span><span class=c1></span><span class=n>pArg</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>fmt</span><span class=p>);</span>   <span class=c1>//等价于原来的va_start
</span><span class=c1></span>
<span class=k>do</span>
<span class=p>{</span>
<span class=n>c</span> <span class=o>=*</span><span class=n>fmt</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>!=</span> <span class=sc>&#39;%&#39;</span><span class=p>)</span>
<span class=p>{</span>
<span class=n>putchar</span><span class=p>(</span><span class=n>c</span><span class=p>);</span>   <span class=c1>//照原样输出字符
</span><span class=c1></span><span class=p>}</span>
<span class=k>else</span>
<span class=p>{</span>
<span class=c1>//按格式字符输出数据
</span><span class=c1></span><span class=k>switch</span><span class=p>(</span><span class=o>*++</span><span class=n>fmt</span><span class=p>)</span>
<span class=p>{</span>
<span class=k>case</span> <span class=sc>&#39;d&#39;</span><span class=o>:</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pArg</span><span class=p>));</span>
<span class=k>break</span><span class=p>;</span>
<span class=k>case</span> <span class=sc>&#39;x&#39;</span><span class=o>:</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%#x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pArg</span><span class=p>));</span>
<span class=k>break</span><span class=p>;</span>
<span class=k>default</span><span class=o>:</span>
<span class=k>break</span><span class=p>;</span>
<span class=p>}</span>
<span class=n>pArg</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span>   <span class=c1>//等价于原来的va_arg
</span><span class=c1></span><span class=p>}</span>
<span class=o>++</span><span class=n>fmt</span><span class=p>;</span>
<span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=o>*</span><span class=n>fmt</span> <span class=o>!=</span> <span class=err>&#39;</span><span class=o>/</span><span class=mi>0</span><span class=err>&#39;</span><span class=p>);</span>
<span class=n>pArg</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>   <span class=c1>//等价于va_end
</span><span class=c1></span><span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1234</span><span class=p>;</span>
<span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>5678</span><span class=p>;</span>

<span class=n>myprintf</span><span class=p>(</span><span class=s>&#34;the first test:i=%d&#34;</span><span class=p>,</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>);</span>
<span class=n>myprintf</span><span class=p>(</span><span class=s>&#34;the secend test:i=%d; %x;j=%d;&#34;</span><span class=p>,</span><span class=n>i</span><span class=p>,</span><span class=mh>0xabcd</span><span class=p>,</span><span class=n>j</span><span class=p>);</span>
<span class=n>system</span><span class=p>(</span><span class=s>&#34;pause&#34;</span><span class=p>);</span>
<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>在intel+win2k+vc6的机器执行结果如下：</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>the first test:i=1234
the secend test:i=1234; 0xabcd;j=5678;
</code></pre></div><h3 id=四-应用>四. 应用</h3><p>求最大值~~(原文代码有问题，重写了一个)~~:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdarg.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=p>...);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>max</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>));</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=p>...)</span>    <span class=c1>// n记录可变参数的数量
</span><span class=c1></span><span class=p>{</span>  
        <span class=n>va_list</span> <span class=n>ap</span><span class=p>;</span>
        <span class=n>va_start</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>    <span class=c1>// 将ap指向n的后一个参数
</span><span class=c1></span>
        <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>tmp</span><span class=p>,</span> <span class=n>max_num</span><span class=o>=</span><span class=n>va_arg</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=kt>int</span><span class=p>);</span>
        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>   <span class=c1>// 计算最大值
</span><span class=c1></span>        <span class=p>{</span>   
                <span class=k>if</span><span class=p>(</span><span class=n>max_num</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>tmp</span><span class=o>=</span><span class=n>va_arg</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=kt>int</span><span class=p>)))</span> 
                        <span class=n>max_num</span> <span class=o>=</span> <span class=n>tmp</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>va_end</span><span class=p>(</span><span class=n>ap</span><span class=p>);</span>    <span class=c1>// 清除ap
</span><span class=c1></span>        <span class=k>return</span> <span class=n>max_num</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments 💬" theme=boxy-light crossorigin=anonymous async defer></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2022</a></li></ul></footer></div><script async src=https://fastly.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/async.min.e8b856a43b93a78048deb0cb92ad99794ad3acb0a2c8093599a653ece0f0a17be8763cdfc99be237c1100cf84542be5aeebc0a7cac0935c48e7b3c95b87c6f34.js onload=window.GistEmbed.init()></script><script async defer src=https://fastly.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubar.co/ga-proxy/"</script><script src=https://fastly.jsdelivr.net/npm/cfga@1.0.3 async defer></script></body></html>