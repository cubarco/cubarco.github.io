<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>[è½¬] Cä¸­çš„å¯å˜å‚æ•°ç ”ç©¶ - /home/cubl</title><meta property="og:title" content="[è½¬] Cä¸­çš„å¯å˜å‚æ•°ç ”ç©¶ - /home/cubl"><link href=/favicon.ico rel=icon type=image/x-icon><meta name=description content="Pwning for fun."><link rel=stylesheet href=/css/main.min.3e07042924f5f343751777161df11be0644abfc5b0c6b2a193c888cc048b16ed.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>[è½¬] Cä¸­çš„å¯å˜å‚æ•°ç ”ç©¶</h1><span class=article-date>2014-02-25</span>
<a class=article-tag href=/tags/c>C</a><div class=article-content><p><em><del>åˆå­¦Cï¼Œæ„Ÿè§‰å¯å˜å‚æ•°æŒºå¥½ç©çš„ï¼Œè½¬è½½ä¸€å‘åšä¸ªmarkã€‚æœ¬æƒ³æ³¨æ˜æ¥æºï¼Œå‘ç°æ¥æºä¹Ÿæ˜¯è½¬è½½çš„ï¼Œæ‰¾ä¸åˆ°æ ¹æºï¼Œå°±ä¸è´´é“¾æ¥äº†ã€‚</del></em></p><h3 id=ä¸€-ä½•è°“å¯å˜å‚æ•°>ä¸€. ä½•è°“å¯å˜å‚æ•°</h3><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>printf</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>format</span><span class=p>,</span> <span class=p>...);</span>
</code></pre></div><p>è¿™æ˜¯ä½¿ç”¨è¿‡Cè¯­è¨€çš„äººæ‰€å†ç†Ÿæ‚‰ä¸è¿‡çš„printfå‡½æ•°åŸå‹ï¼Œå®ƒçš„å‚æ•°ä¸­å°±æœ‰å›ºå®šå‚æ•°formatå’Œå¯å˜å‚æ•°ï¼ˆç”¨â€â€¦â€è¡¨ç¤ºï¼‰. Â  è€Œæˆ‘ä»¬åˆå¯ä»¥ç”¨å„ç§æ–¹å¼æ¥è°ƒç”¨printf,å¦‚:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=n>value</span><span class=p>);</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span><span class=n>str</span><span class=p>);</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;the number is %d,string is: %s&#34;</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</code></pre></div><h3 id=äºŒ-å®ç°åŸç†>äºŒ. å®ç°åŸç†</h3><p>Cè¯­è¨€ç”¨å®æ¥å¤„ç†è¿™äº›å¯å˜å‚æ•°ã€‚è¿™äº›å®çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå…¶å®åŸç†æŒºç®€å•ï¼Œå°±æ˜¯æ ¹æ®å‚æ•°å…¥æ ˆçš„ç‰¹ç‚¹ä»æœ€é è¿‘ç¬¬ä¸€ä¸ªå¯å˜å‚æ•°çš„å›ºå®šå‚æ•°å¼€å§‹ï¼Œä¾æ¬¡è·å–æ¯ä¸ªå¯å˜å‚æ•°çš„åœ°å€ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æè¿™äº›å®ã€‚åœ¨VCä¸­çš„stdarg.hå¤´æ–‡ä»¶ä¸­ï¼Œé’ˆå¯¹ä¸åŒå¹³å°æœ‰ä¸åŒçš„å®å®šä¹‰ï¼Œæˆ‘ä»¬é€‰å–X86å¹³å°ä¸‹çš„å®å®šä¹‰ï¼š</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=kt>char</span> <span class=o>*</span><span class=n>va_list</span><span class=p>;</span>
<span class=cm>/*æŠŠva_listè¢«å®šä¹‰æˆchar*ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æˆ‘ä»¬ç›®å‰æ‰€ç”¨çš„PCæœºä¸Šï¼Œå­—ç¬¦æŒ‡é’ˆç±»å‹å¯ä»¥ç”¨æ¥å­˜å‚¨å†…å­˜å•å…ƒåœ°å€ã€‚è€Œåœ¨æœ‰çš„æœºå™¨ä¸Šva_listæ˜¯è¢«å®šä¹‰æˆvoid*çš„*/</span>
<span class=cp>#define _INTSIZEOF(n) ((sizeof(n) + sizeof(int) - 1) &amp; ~(sizeof(int) - 1))
</span><span class=cp></span><span class=cm>/*_INTSIZEOF(n)å®æ˜¯ä¸ºäº†è€ƒè™‘é‚£äº›å†…å­˜åœ°å€éœ€è¦å¯¹é½çš„ç³»ç»Ÿï¼Œä»å®çš„åå­—æ¥åº”è¯¥æ˜¯è·Ÿsizeof(int)å¯¹é½ã€‚ä¸€èˆ¬çš„sizeof(int)=4ï¼Œä¹Ÿå°±æ˜¯å‚æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€éƒ½ä¸º4çš„å€æ•°ã€‚æ¯”å¦‚ï¼Œå¦‚æœsizeof(n)åœ¨1ï¼4ä¹‹é—´ï¼Œé‚£ä¹ˆ_INTSIZEOF(n)ï¼4ï¼›å¦‚æœsizeof(n)åœ¨5ï¼8ä¹‹é—´ï¼Œé‚£ä¹ˆ_INTSIZEOF(n)=8ã€‚*/</span>
<span class=cp>#define va_start(ap,v)(ap = (va_list)&amp;v + _INTSIZEOF(v))
</span><span class=cp></span><span class=cm>/*va_startçš„å®šä¹‰ä¸º &amp;v+_INTSIZEOF(v), è¿™é‡Œ&amp;væ˜¯æœ€åä¸€ä¸ªå›ºå®šå‚æ•°çš„èµ·å§‹åœ°å€ï¼Œå†åŠ ä¸Šå…¶å®é™…å ç”¨å¤§å°åï¼Œå°±å¾—åˆ°äº†ç¬¬ä¸€ä¸ªå¯å˜å‚æ•°çš„èµ·å§‹å†…å­˜åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬è¿è¡Œva_start(ap, v)ä»¥å,apæŒ‡å‘ç¬¬ä¸€ä¸ªå¯å˜å‚æ•°åœ¨çš„å†…å­˜åœ°å€*/</span>
<span class=cp>#define va_arg(ap,t) (*(t*)((ap += _INTSIZEOF(t)) - _INTSIZEOF(t)))
</span><span class=cp></span><span class=cm>/*è¿™ä¸ªå®åšäº†ä¸¤ä¸ªäº‹æƒ…ï¼Œ
</span><span class=cm>â‘ ç”¨ç”¨æˆ·è¾“å…¥çš„ç±»å‹åå¯¹å‚æ•°åœ°å€è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå¾—åˆ°ç”¨æˆ·æ‰€éœ€è¦çš„å€¼
</span><span class=cm>â‘¡è®¡ç®—å‡ºæœ¬å‚æ•°çš„å®é™…å¤§å°ï¼Œå°†æŒ‡é’ˆè°ƒåˆ°æœ¬å‚æ•°çš„ç»“å°¾ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªå‚æ•°çš„é¦–åœ°å€ï¼Œä»¥ä¾¿åç»­å¤„ç†ã€‚*/</span>
<span class=cp>#define va_end(ap) (ap = (va_list)0)
</span><span class=cp></span><span class=cm>/*x86å¹³å°å®šä¹‰ä¸ºap=(char*)0;ä½¿apä¸å†æŒ‡å‘å †æ ˆ,è€Œæ˜¯è·ŸNULLä¸€æ ·.æœ‰äº›ç›´æ¥å®šä¹‰ä¸º((void*)0),è¿™æ ·ç¼–è¯‘å™¨ä¸ä¼šä¸ºva_endäº§ç”Ÿä»£ç ,ä¾‹å¦‚gccåœ¨linuxçš„x86å¹³å°å°±æ˜¯è¿™æ ·å®šä¹‰çš„.åœ¨è¿™é‡Œå¤§å®¶è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜:ç”±äºå‚æ•°çš„åœ°å€ç”¨äºva_startå®,æ‰€ä»¥å‚æ•°ä¸èƒ½å£°æ˜ä¸ºå¯„å­˜å™¨å˜é‡æˆ–ä½œä¸ºå‡½æ•°æˆ–æ•°ç»„ç±»å‹.*/</span>
</code></pre></div><p>ä»¥ä¸‹å†ç”¨å›¾æ¥è¡¨ç¤º~~(è¿™ä»€ä¹ˆç ´å›¾)~~:</p><p>åœ¨VCç­‰ç»å¤§å¤šæ•°Cç¼–è¯‘å™¨ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå‚æ•°è¿›æ ˆçš„é¡ºåºæ˜¯ç”±å³å‘å·¦çš„ï¼Œå› æ­¤ï¼Œå‚æ•°è¿›æ ˆä»¥åçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šæœ€åä¸€ä¸ªå›ºå®šå‚æ•°çš„åœ°å€ä½äºç¬¬ä¸€ä¸ªå¯å˜å‚æ•°ä¹‹ä¸‹ï¼Œå¹¶ä¸”æ˜¯è¿ç»­å­˜å‚¨çš„ã€‚</p><h3 id=ä¸‰-printfç ”ç©¶>ä¸‰. printfç ”ç©¶</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„printfå‡½æ•°çš„å®ç°ã€‚<del>ï¼ˆä½œè€…ç®€ç›´æ˜¯å¹½é»˜ï¼Œæ‰€è°“printfå‡½æ•°çš„å®ç°é‡Œé¢å±…ç„¶ç”¨åˆ°äº†printfå‡½æ•°ã€‚ã€‚ã€‚ï¼‰</del></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&#34;stdio.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;stdlib.h&#34;</span><span class=cp>
</span><span class=cp></span><span class=kt>void</span> <span class=nf>myprintf</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span> <span class=c1>//ä¸€ä¸ªç®€å•çš„ç±»ä¼¼äºprintfçš„å®ç°,å‚æ•°å¿…é¡»éƒ½æ˜¯intç±»å‹
</span><span class=c1></span><span class=p>{</span>
<span class=kt>char</span><span class=o>*</span> <span class=n>pArg</span><span class=o>=</span><span class=nb>NULL</span><span class=p>;</span> Â  <span class=c1>//ç­‰ä»·äºåŸæ¥çš„va_list
</span><span class=c1></span><span class=kt>char</span> <span class=n>c</span><span class=p>;</span>

<span class=n>pArg</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>fmt</span><span class=p>;</span> Â  <span class=c1>//æ³¨æ„ä¸è¦å†™æˆp = fmt, å› ä¸ºè¿™é‡Œè¦å¯¹å‚æ•°å–å€ï¼Œè€Œä¸æ˜¯å–å€¼
</span><span class=c1></span><span class=n>pArg</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>fmt</span><span class=p>);</span> Â  <span class=c1>//ç­‰ä»·äºåŸæ¥çš„va_start
</span><span class=c1></span>
<span class=k>do</span>
<span class=p>{</span>
<span class=n>c</span> <span class=o>=*</span><span class=n>fmt</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>!=</span> <span class=sc>&#39;%&#39;</span><span class=p>)</span>
<span class=p>{</span>
<span class=n>putchar</span><span class=p>(</span><span class=n>c</span><span class=p>);</span> Â  <span class=c1>//ç…§åŸæ ·è¾“å‡ºå­—ç¬¦
</span><span class=c1></span><span class=p>}</span>
<span class=k>else</span>
<span class=p>{</span>
<span class=c1>//æŒ‰æ ¼å¼å­—ç¬¦è¾“å‡ºæ•°æ®
</span><span class=c1></span><span class=k>switch</span><span class=p>(</span><span class=o>*++</span><span class=n>fmt</span><span class=p>)</span>
<span class=p>{</span>
<span class=k>case</span> <span class=sc>&#39;d&#39;</span><span class=o>:</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pArg</span><span class=p>));</span>
<span class=k>break</span><span class=p>;</span>
<span class=k>case</span> <span class=sc>&#39;x&#39;</span><span class=o>:</span>
<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%#x&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>pArg</span><span class=p>));</span>
<span class=k>break</span><span class=p>;</span>
<span class=k>default</span><span class=o>:</span>
<span class=k>break</span><span class=p>;</span>
<span class=p>}</span>
<span class=n>pArg</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span> Â  <span class=c1>//ç­‰ä»·äºåŸæ¥çš„va_arg
</span><span class=c1></span><span class=p>}</span>
<span class=o>++</span><span class=n>fmt</span><span class=p>;</span>
<span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=o>*</span><span class=n>fmt</span> <span class=o>!=</span> <span class=err>&#39;</span><span class=o>/</span><span class=mi>0</span><span class=err>&#39;</span><span class=p>);</span>
<span class=n>pArg</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> Â  <span class=c1>//ç­‰ä»·äºva_end
</span><span class=c1></span><span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1234</span><span class=p>;</span>
<span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>5678</span><span class=p>;</span>

<span class=n>myprintf</span><span class=p>(</span><span class=s>&#34;the first test:i=%d&#34;</span><span class=p>,</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>);</span>
<span class=n>myprintf</span><span class=p>(</span><span class=s>&#34;the secend test:i=%d; %x;j=%d;&#34;</span><span class=p>,</span><span class=n>i</span><span class=p>,</span><span class=mh>0xabcd</span><span class=p>,</span><span class=n>j</span><span class=p>);</span>
<span class=n>system</span><span class=p>(</span><span class=s>&#34;pause&#34;</span><span class=p>);</span>
<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>åœ¨intel+win2k+vc6çš„æœºå™¨æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>the first test:i=1234
the secend test:i=1234; 0xabcd;j=5678;
</code></pre></div><h3 id=å››-åº”ç”¨>å››. åº”ç”¨</h3><p>æ±‚æœ€å¤§å€¼~~(åŸæ–‡ä»£ç æœ‰é—®é¢˜ï¼Œé‡å†™äº†ä¸€ä¸ª)~~:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdarg.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=p>...);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>max</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>));</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=p>...)</span>    <span class=c1>// nè®°å½•å¯å˜å‚æ•°çš„æ•°é‡
</span><span class=c1></span><span class=p>{</span>  
        <span class=n>va_list</span> <span class=n>ap</span><span class=p>;</span>
        <span class=n>va_start</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>    <span class=c1>// å°†apæŒ‡å‘nçš„åä¸€ä¸ªå‚æ•°
</span><span class=c1></span>
        <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>tmp</span><span class=p>,</span> <span class=n>max_num</span><span class=o>=</span><span class=n>va_arg</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=kt>int</span><span class=p>);</span>
        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>   <span class=c1>// è®¡ç®—æœ€å¤§å€¼
</span><span class=c1></span>        <span class=p>{</span>   
                <span class=k>if</span><span class=p>(</span><span class=n>max_num</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>tmp</span><span class=o>=</span><span class=n>va_arg</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=kt>int</span><span class=p>)))</span> 
                        <span class=n>max_num</span> <span class=o>=</span> <span class=n>tmp</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>va_end</span><span class=p>(</span><span class=n>ap</span><span class=p>);</span>    <span class=c1>// æ¸…é™¤ap
</span><span class=c1></span>        <span class=k>return</span> <span class=n>max_num</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments ğŸ’¬" theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>Â© 2014 - 2014</a></li></ul></footer></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js async></script><script src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/main.min.60d77477267181e7581bba5435ded18ab8ff1db3955dde2d3afeec25cc51d24e32b178b6c1ebb5edc2a4cef04c8f592408eb2811f0c78c9295b8a0939977a6a1.js async></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-54867602-1','auto'),ga('send','pageview'))</script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.pwn.ooo/umami.js></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script></body></html>